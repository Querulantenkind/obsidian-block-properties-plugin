/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var _=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var re=Object.prototype.hasOwnProperty;var le=(u,i)=>{for(var e in i)_(u,e,{get:i[e],enumerable:!0})},ae=(u,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of oe(i))!re.call(u,t)&&t!==e&&_(u,t,{get:()=>i[t],enumerable:!(s=ie(i,t))||s.enumerable});return u};var ce=u=>ae(_({},"__esModule",{value:!0}),u);var ve={};le(ve,{default:()=>q});module.exports=ce(ve);var se=require("obsidian");var W=require("@codemirror/state"),b=require("@codemirror/view");var X=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,J=/\^([\w-]+)/g;function I(u){var s;let i=[];X.lastIndex=0;let e;for(;(e=X.exec(u))!==null;){let t=e[1];!t||t.trim()===""||i.push({type:"note",raw:e[0],target:t.trim(),alias:(s=e[2])==null?void 0:s.trim()})}for(J.lastIndex=0;(e=J.exec(u))!==null;){let t=e[1];if(!t)continue;let n=e.index;i.some(c=>{if(c.type!=="note")return!1;let a=u.indexOf(c.raw),l=a+c.raw.length;return n>=a&&n<l})||i.push({type:"block",raw:e[0],target:t})}return{raw:u,links:i}}function S(u){let i=I(u),e=[];for(let s of i.links){let t=0,n;for(;(n=u.indexOf(s.raw,t))!==-1;){if(!e.some(c=>c.from===n&&c.link.raw===s.raw)){e.push({from:n,to:n+s.raw.length,link:s});break}t=n+1}}return e.sort((s,t)=>s.from-t.from),e}var Y=/\^([\w-]+)\s*\[([^\]]+)\]/g;function y(u,i=0){let e=[],s;for(Y.lastIndex=0;(s=Y.exec(u))!==null;){let t=s[1],n=s[2];if(!t||!n)continue;let o=pe(n);e.push({blockId:t,properties:o,from:i+s.index,to:i+s.index+s[0].length})}return e}function pe(u){let i=[],e=u.split(",");for(let s of e){let t=s.indexOf(":");if(t===-1)continue;let n=s.slice(0,t).trim(),o=s.slice(t+1).trim();if(n){let c=I(o);i.push({key:n,value:o,parsedValue:c})}}return i}function de(u,i,e){let s=u.metadataCache.getFirstLinkpathDest(i,e);return{file:s,exists:s!==null}}async function ue(u,i,e,s=!0){if(e){let t=await u.vault.cachedRead(e),n=Z(t,i);if(n!==-1)return{file:e,blockId:i,line:n,exists:!0}}if(s)for(let t of u.vault.getMarkdownFiles()){if(t===e)continue;let n=await u.vault.cachedRead(t),o=Z(n,i);if(o!==-1)return{file:t,blockId:i,line:o,exists:!0}}return{file:null,exists:!1}}function Z(u,i){let e=u.split(`
`),s=new RegExp(`\\^${i}(?:\\s|\\[|$)`);for(let t=0;t<e.length;t++){let n=e[t];if(n&&s.test(n))return t}return-1}async function F(u,i,e,s){if(i.type==="note"){let t=de(u,i.target,e);if(t.file)return await u.workspace.getLeaf().openFile(t.file),!0}else if(i.type==="block"){let t=await ue(u,i.target,s);if(t.file&&t.line!==void 0){let n=u.workspace.getLeaf();await n.openFile(t.file);let o=n.view;return o.getViewType()==="markdown"&&setTimeout(()=>{let c=o.editor;c&&(c.setCursor({line:t.line,ch:0}),c.scrollIntoView({from:{line:t.line,ch:0},to:{line:t.line,ch:0}},!0))},100),!0}}return!1}var he=b.Decoration.mark({class:"block-property"}),j=class extends b.WidgetType{constructor(e,s){super();this.blockId=e;this.properties=s}toDOM(){let e=document.createElement("span");e.className="block-property-badge",e.setAttribute("data-block-id",this.blockId),e.setAttribute("data-properties",JSON.stringify(this.properties));let s=this.properties.length;return e.textContent=`${s}`,e.title=this.properties.map(t=>`${t.key}: ${t.value}`).join(", "),e}eq(e){return this.blockId===e.blockId&&JSON.stringify(this.properties)===JSON.stringify(e.properties)}};function ke(u){class i{constructor(s){this.decorations=this.buildDecorations(s)}update(s){(s.docChanged||s.viewportChanged)&&(this.decorations=this.buildDecorations(s.view))}destroy(){}buildDecorations(s){let t=new W.RangeSetBuilder;for(let{from:n,to:o}of s.visibleRanges){let c=s.state.doc.sliceString(n,o),a=y(c,n);for(let l of a){let r=s.state.doc.sliceString(l.from,l.to).indexOf("[");if(r!==-1){let d=l.from+r,h=l.to;if(u==="badge"){let f=new j(l.blockId,l.properties);t.add(d,h,b.Decoration.replace({widget:f}))}else t.add(d,h,he)}}}return t.finish()}}return b.ViewPlugin.fromClass(i,{decorations:e=>e.decorations})}var me=(0,b.hoverTooltip)((u,i)=>{let e=u.state.doc.lineAt(i),s=e.text,t=e.from,n=y(s,t);for(let o of n){let a=u.state.doc.sliceString(o.from,o.to).indexOf("[");if(a!==-1){let l=o.from+a,p=o.to;if(i>=l&&i<=p)return{pos:l,above:!0,create(){let r=document.createElement("div");r.className="block-properties-tooltip";let d=document.createElement("div");d.className="block-properties-tooltip-header",d.textContent=`^${o.blockId}`,r.appendChild(d);let h=document.createElement("div");h.className="block-properties-tooltip-list";for(let f of o.properties){let k=document.createElement("div");k.className="block-properties-tooltip-item";let m=document.createElement("span");m.className="block-properties-tooltip-key",m.textContent=f.key;let g=document.createElement("span");g.className="block-properties-tooltip-value",g.textContent=f.value,k.appendChild(m),k.appendChild(g),h.appendChild(k)}return r.appendChild(h),{dom:r}}}}}return null}),fe=b.Decoration.mark({class:"block-property-link"}),U=new WeakMap;function ge(){class u{constructor(e){this.linkPositions=[];let s=this.buildLinkDecorations(e);this.decorations=s.decorations,this.linkPositions=s.positions,U.set(e,this.linkPositions)}update(e){if(e.docChanged||e.viewportChanged){let s=this.buildLinkDecorations(e.view);this.decorations=s.decorations,this.linkPositions=s.positions,U.set(e.view,this.linkPositions)}}destroy(){}buildLinkDecorations(e){let s=new W.RangeSetBuilder,t=[];for(let{from:n,to:o}of e.visibleRanges){let c=e.state.doc.sliceString(n,o),a=y(c,n);for(let l of a){let p=e.state.doc.sliceString(l.from,l.to),r=p.indexOf("["),d=p.lastIndexOf("]");if(r===-1||d===-1)continue;let h=p.slice(r+1,d),f=l.from+r+1,k=0;for(let m of l.properties){let g=`${m.key}: ${m.value}`,v=h.indexOf(g,k);if(v===-1)continue;let B=v+m.key.length+2,C=f+B,ne=S(m.value);for(let K of ne){let z=C+K.from,G=C+K.to;s.add(z,G,fe),t.push({from:z,to:G,link:K.link})}k=v+g.length}}}return{decorations:s.finish(),positions:t}}}return b.ViewPlugin.fromClass(u,{decorations:i=>i.decorations})}function ye(u){return b.EditorView.domEventHandlers({click:(i,e)=>{if(!i.metaKey&&!i.ctrlKey)return!1;let s=e.posAtCoords({x:i.clientX,y:i.clientY});if(s===null)return!1;let t=U.get(e);if(!t)return!1;for(let n of t)if(s>=n.from&&s<=n.to){i.preventDefault();let o=u.workspace.getActiveFile(),c=(o==null?void 0:o.path)||"";return F(u,n.link,c,o||void 0),!0}return!1}})}function Q(u,i){let e=[ke(u),me];return i&&(e.push(ge()),e.push(ye(i))),e}var E=require("obsidian");var T="block-properties-panel",M=class extends E.ItemView{constructor(e,s){super(e);this.currentFile=null;this.plugin=s}getViewType(){return T}getDisplayText(){return"Block Properties"}getIcon(){return"tag"}async onOpen(){this.renderPanel()}async onClose(){}async updateForFile(e){this.currentFile=e,this.renderPanel()}async renderPanel(){let{contentEl:e}=this;e.empty(),e.addClass("block-properties-panel");let s=e.createEl("div",{cls:"block-properties-panel-header"});if(!this.currentFile){s.createEl("h4",{text:"Block Properties"}),e.createEl("p",{text:"No file open",cls:"block-properties-panel-empty"});return}s.createEl("h4",{text:this.currentFile.basename});let t=await this.app.vault.cachedRead(this.currentFile),n=this.extractBlocks(t);if(n.length===0){e.createEl("p",{text:"No block properties found",cls:"block-properties-panel-empty"});return}let o=e.createEl("p",{cls:"block-properties-panel-count"});o.textContent=`${n.length} block(s) with properties`;let c=e.createEl("div",{cls:"block-properties-panel-list"});for(let r of n){let d=c.createEl("div",{cls:"block-properties-panel-item"}),h=d.createEl("div",{cls:"block-properties-panel-item-header"});h.createEl("a",{text:`^${r.blockId}`,cls:"block-properties-panel-link"}).addEventListener("click",()=>{this.navigateToBlock(r.line)}),r.context&&h.createEl("span",{text:r.context,cls:"block-properties-panel-context"});let k=d.createEl("div",{cls:"block-properties-panel-props"});for(let g of r.properties){let v=k.createEl("div",{cls:"block-properties-panel-prop"});v.createEl("span",{text:g.key,cls:"block-properties-panel-key"});let B=v.createEl("div",{cls:"block-properties-panel-value-container"});this.renderPropertyValue(B,g.value,r,g.key);let C=v.createEl("button",{cls:"block-properties-panel-delete-btn",attr:{"aria-label":"Delete property"}});C.innerHTML="&times;",C.addEventListener("click",()=>{this.deleteProperty(r,g.key)})}let m=k.createEl("button",{text:"+ Add property",cls:"block-properties-panel-add-btn"});m.addEventListener("click",()=>{this.startAddingProperty(k,r,m)})}this.plugin.settings.showBacklinksInPanel&&await this.renderBacklinks(e,n);let a=e.createEl("div",{cls:"block-properties-panel-summary"});a.createEl("h5",{text:"Summary"});let l=this.countKeys(n),p=a.createEl("div",{cls:"block-properties-panel-summary-list"});for(let[r,d]of Object.entries(l)){let h=p.createEl("div",{cls:"block-properties-panel-summary-item"});h.createEl("span",{text:r,cls:"block-properties-panel-summary-key"}),h.createEl("span",{text:`${d}`,cls:"block-properties-panel-summary-count"})}}extractBlocks(e){let s=[],t=e.split(`
`);for(let n=0;n<t.length;n++){let o=t[n];if(!o)continue;let c=y(o);for(let a of c){let l=o.slice(0,a.from).trim().slice(0,40),r=o.slice(a.from,a.to).indexOf("[");s.push({blockId:a.blockId,properties:a.properties,line:n,context:l||"(start of line)",blockStart:a.from,propsStart:a.from+r,propsEnd:a.to-1})}}return s}countKeys(e){let s={};for(let t of e)for(let n of t.properties)s[n.key]=(s[n.key]||0)+1;return s}navigateToBlock(e){let s=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(s){let t=s.editor;t.setCursor({line:e,ch:0}),t.scrollIntoView({from:{line:e,ch:0},to:{line:e,ch:0}},!0),t.focus()}}renderPropertyValue(e,s,t,n){if(!s){e.createEl("span",{text:"(empty)",cls:"block-properties-panel-value is-empty"}).addEventListener("click",()=>{this.startEditingValue(e,t,n,s)});return}let o=S(s);if(o.length===0){e.createEl("span",{text:s,cls:"block-properties-panel-value"}).addEventListener("click",()=>{this.startEditingValue(e,t,n,s)});return}let c=e.createEl("span",{cls:"block-properties-panel-value block-properties-panel-value-with-links"}),a=0;for(let p of o)p.from>a&&c.createEl("span",{text:s.slice(a,p.from)}).addEventListener("click",()=>{this.startEditingValue(e,t,n,s)}),c.createEl("a",{text:p.link.alias||p.link.target,cls:`block-properties-panel-link-value block-properties-link-${p.link.type}`}).addEventListener("click",async d=>{var k;d.stopPropagation();let h=((k=this.currentFile)==null?void 0:k.path)||"";await F(this.app,p.link,h,this.currentFile||void 0)||new E.Notice(`Could not find ${p.link.type==="note"?"note":"block"}: ${p.link.target}`)}),a=p.to;a<s.length&&c.createEl("span",{text:s.slice(a)}).addEventListener("click",()=>{this.startEditingValue(e,t,n,s)}),c.createEl("span",{text:" \u270E",cls:"block-properties-panel-edit-icon"}).addEventListener("click",()=>{this.startEditingValue(e,t,n,s)})}async renderBacklinks(e,s){let t=this.plugin.getBacklinkIndex();if(!t)return;let n=[];for(let c of s){let a=t.getBacklinksForBlock(c.blockId);a.length>0&&n.push({targetId:`^${c.blockId}`,entries:a})}if(n.length===0)return;let o=e.createEl("div",{cls:"block-properties-panel-backlinks"});o.createEl("h5",{text:"Referenced by"});for(let{targetId:c,entries:a}of n){o.createEl("div",{cls:"block-properties-panel-backlinks-target"}).createEl("span",{text:c,cls:"block-properties-panel-backlinks-target-id"});let p=o.createEl("div",{cls:"block-properties-panel-backlinks-list"});for(let r of a){let d=p.createEl("div",{cls:"block-properties-panel-backlinks-item"}),h=this.app.vault.getAbstractFileByPath(r.sourceFile),f=h instanceof E.TFile?`${h.basename} \u2192 ^${r.sourceBlockId}`:`${r.sourceFile} \u2192 ^${r.sourceBlockId}`;d.createEl("a",{text:f,cls:"block-properties-panel-backlinks-link"}).addEventListener("click",async()=>{h instanceof E.TFile&&(await this.app.workspace.getLeaf().openFile(h),setTimeout(()=>{let g=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(g){let v=g.editor;v.setCursor({line:r.line,ch:0}),v.scrollIntoView({from:{line:r.line,ch:0},to:{line:r.line,ch:0}},!0)}},100))}),d.createEl("span",{text:` (${r.key})`,cls:"block-properties-panel-backlinks-key"})}}}startEditingValue(e,s,t,n){e.empty();let o=e.createEl("input",{type:"text",value:n,cls:"block-properties-panel-edit-input"}),c=e.createEl("div",{cls:"block-properties-panel-dropdown"});this.populateValueDropdown(c,t,o),o.focus(),o.select(),o.addEventListener("input",()=>{this.populateValueDropdown(c,t,o)});let a=async()=>{let l=o.value.trim();await this.updateProperty(s,t,l)};o.addEventListener("blur",()=>{setTimeout(()=>{e.contains(document.activeElement)||a()},150)}),o.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),a()):l.key==="Escape"&&this.renderPanel()})}populateValueDropdown(e,s,t){e.empty();let n=this.plugin.getSuggest();if(!n){e.hide();return}let o=n.getValuesForKey(s),c=t.value.toLowerCase(),a=Array.from(o.entries()).filter(([l])=>l.toLowerCase().includes(c)).sort((l,p)=>p[1]-l[1]).slice(0,5);if(a.length===0){e.hide();return}e.show();for(let[l,p]of a){let r=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});r.createEl("span",{text:l}),r.createEl("span",{text:`${p}`,cls:"block-properties-panel-dropdown-count"}),r.addEventListener("click",()=>{t.value=l,t.focus(),e.hide()})}}startAddingProperty(e,s,t){t.remove();let n=e.createEl("div",{cls:"block-properties-panel-prop block-properties-panel-new-prop"}),o=n.createEl("input",{type:"text",placeholder:"key",cls:"block-properties-panel-edit-input block-properties-panel-key-input"});n.createEl("span",{text:":"});let c=n.createEl("input",{type:"text",placeholder:"value",cls:"block-properties-panel-edit-input"}),a=n.createEl("button",{text:"\u2713",cls:"block-properties-panel-save-btn"}),l=n.createEl("button",{text:"\xD7",cls:"block-properties-panel-cancel-btn"});o.focus();let p=n.createEl("div",{cls:"block-properties-panel-dropdown block-properties-panel-key-dropdown"});o.addEventListener("input",()=>{this.populateKeyDropdown(p,o,c)}),a.addEventListener("click",async()=>{let r=o.value.trim(),d=c.value.trim();r&&await this.addProperty(s,r,d)}),l.addEventListener("click",()=>{this.renderPanel()}),c.addEventListener("keydown",r=>{r.key==="Enter"?a.click():r.key==="Escape"&&l.click()}),o.addEventListener("keydown",r=>{r.key==="Escape"&&l.click()})}populateKeyDropdown(e,s,t){e.empty();let n=this.plugin.getSuggest();if(!n){e.hide();return}let o=n.getKeys(),c=s.value.toLowerCase(),a=Array.from(o.entries()).filter(([l])=>l.toLowerCase().includes(c)).sort((l,p)=>p[1]-l[1]).slice(0,5);if(a.length===0){e.hide();return}e.show();for(let[l,p]of a){let r=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});r.createEl("span",{text:l}),r.createEl("span",{text:`${p}`,cls:"block-properties-panel-dropdown-count"}),r.addEventListener("click",()=>{s.value=l,t.focus(),e.hide()})}}async updateProperty(e,s,t){if(this.currentFile)try{let o=(await this.app.vault.read(this.currentFile)).split(`
`),c=o[e.line];if(!c)return;let l=e.properties.map(h=>h.key===s?{key:s,value:t}:h).map(h=>`${h.key}: ${h.value}`).join(", "),p=c.slice(0,e.propsStart),r=c.slice(e.propsEnd+1),d=`${p}[${l}]${r}`;o[e.line]=d,await this.app.vault.modify(this.currentFile,o.join(`
`)),this.renderPanel()}catch(n){new E.Notice("Failed to update property")}}async addProperty(e,s,t){if(this.currentFile){if(e.properties.find(n=>n.key===s)){await this.updateProperty(e,s,t);return}try{let o=(await this.app.vault.read(this.currentFile)).split(`
`),c=o[e.line];if(!c)return;let l=[...e.properties,{key:s,value:t}].map(h=>`${h.key}: ${h.value}`).join(", "),p=c.slice(0,e.propsStart),r=c.slice(e.propsEnd+1),d=`${p}[${l}]${r}`;o[e.line]=d,await this.app.vault.modify(this.currentFile,o.join(`
`)),this.renderPanel()}catch(n){new E.Notice("Failed to add property")}}}async deleteProperty(e,s){if(this.currentFile)try{let n=(await this.app.vault.read(this.currentFile)).split(`
`),o=n[e.line];if(!o)return;let c=e.properties.filter(a=>a.key!==s);if(c.length===0){let a=o.slice(0,e.blockStart),l=o.slice(e.propsEnd+1),p=o.slice(e.blockStart).match(/^\^[\w-]+/),r=`${a}${(p==null?void 0:p[0])||""}${l}`;n[e.line]=r}else{let a=c.map(d=>`${d.key}: ${d.value}`).join(", "),l=o.slice(0,e.propsStart),p=o.slice(e.propsEnd+1),r=`${l}[${a}]${p}`;n[e.line]=r}await this.app.vault.modify(this.currentFile,n.join(`
`)),this.renderPanel()}catch(t){new E.Notice("Failed to delete property")}}};var P=require("obsidian");var $=class extends P.Modal{constructor(i,e){super(i),this.onSubmit=e}onOpen(){let{contentEl:i}=this;i.addClass("block-properties-query-modal"),i.createEl("h2",{text:"Query Block Properties"});let e="",s="";new P.Setting(i).setName("Property key").setDesc('e.g. "status", "priority", "version"').addText(t=>t.setPlaceholder("status").onChange(n=>{e=n})),new P.Setting(i).setName("Property value (optional)").setDesc("Leave empty to find all blocks with this key").addText(t=>t.setPlaceholder("draft").onChange(n=>{s=n})),new P.Setting(i).addButton(t=>t.setButtonText("Search").setCta().onClick(()=>{this.close(),this.onSubmit(e,s)}))}onClose(){let{contentEl:i}=this;i.empty()}},V=class extends P.Modal{constructor(i,e,s){super(i),this.results=e,this.query=s}onOpen(){let{contentEl:i}=this;i.addClass("block-properties-results-modal");let e=this.query.value?`${this.query.key}: ${this.query.value}`:this.query.key;if(i.createEl("h2",{text:`Results for "${e}"`}),i.createEl("p",{text:`Found ${this.results.length} block(s)`,cls:"block-properties-results-count"}),this.results.length===0){i.createEl("p",{text:"No blocks found with matching properties.",cls:"block-properties-no-results"});return}let s=i.createEl("div",{cls:"block-properties-results-list"});for(let t of this.results){let n=s.createEl("div",{cls:"block-properties-result-item"});n.createEl("div",{cls:"block-properties-result-header"}).createEl("a",{text:`${t.file.basename} \u2192 ^${t.blockId}`,cls:"block-properties-result-link"}).addEventListener("click",async l=>{l.preventDefault(),this.close(),await this.app.workspace.getLeaf().openFile(t.file);let r=this.app.workspace.getActiveViewOfType(P.MarkdownView);if(r){let d=r.editor;d.setCursor({line:t.line,ch:0}),d.scrollIntoView({from:{line:t.line,ch:0},to:{line:t.line,ch:0}},!0)}});let a=n.createEl("div",{cls:"block-properties-result-props"});for(let l of t.properties){let p=l.key===this.query.key&&(!this.query.value||l.value===this.query.value);a.createEl("span",{text:`${l.key}: ${l.value}`,cls:`block-properties-result-prop ${p?"is-match":""}`})}t.context&&n.createEl("div",{text:t.context,cls:"block-properties-result-context"})}}onClose(){let{contentEl:i}=this;i.empty()}};async function ee(u,i,e){let s=[],t=u.vault.getMarkdownFiles();for(let n of t){let c=(await u.vault.cachedRead(n)).split(`
`);for(let a=0;a<c.length;a++){let l=c[a];if(!l)continue;let p=y(l);for(let r of p)r.properties.find(h=>h.key===i&&(!e||h.value===e))&&s.push({file:n,line:a,blockId:r.blockId,properties:r.properties,context:l.slice(0,r.from).trim().slice(0,60)})}}return s}var x=require("obsidian");var w=require("obsidian"),N=class extends w.Modal{constructor(i,e,s){super(i),this.isNew=!e,this.template=e?{...e,properties:e.properties.map(t=>({...t}))}:{name:"",properties:[{key:"",value:""}]},this.onSave=s}onOpen(){let{contentEl:i}=this;i.addClass("block-properties-template-modal"),i.createEl("h2",{text:this.isNew?"Create Template":"Edit Template"}),new w.Setting(i).setName("Template name").setDesc('Used in "preset: name" syntax').addText(s=>s.setPlaceholder("task").setValue(this.template.name).onChange(t=>{this.template.name=t.trim().toLowerCase().replace(/\s+/g,"-")})),i.createEl("h4",{text:"Properties"});let e=i.createEl("div",{cls:"block-properties-template-props"});this.renderProperties(e),new w.Setting(i).addButton(s=>s.setButtonText("Cancel").onClick(()=>this.close())).addButton(s=>s.setButtonText("Save").setCta().onClick(()=>{if(!this.template.name){new w.Notice("Template name is required");return}if(this.template.properties=this.template.properties.filter(t=>t.key.trim()),this.template.properties.length===0){new w.Notice("At least one property is required");return}this.onSave(this.template),this.close()}))}renderProperties(i){i.empty();for(let s=0;s<this.template.properties.length;s++){let t=this.template.properties[s];if(!t)continue;let n=i.createEl("div",{cls:"block-properties-template-prop-row"});n.createEl("input",{type:"text",placeholder:"key",value:t.key,cls:"block-properties-template-input"}).addEventListener("input",l=>{t.key=l.target.value}),n.createEl("span",{text:":"}),n.createEl("input",{type:"text",placeholder:"default value",value:t.value,cls:"block-properties-template-input"}).addEventListener("input",l=>{t.value=l.target.value});let a=n.createEl("button",{cls:"block-properties-template-delete-btn"});a.innerHTML="&times;",a.addEventListener("click",()=>{this.template.properties.splice(s,1),this.template.properties.length===0&&this.template.properties.push({key:"",value:""}),this.renderProperties(i)})}i.createEl("button",{text:"+ Add property",cls:"block-properties-template-add-btn"}).addEventListener("click",()=>{this.template.properties.push({key:"",value:""}),this.renderProperties(i)})}onClose(){this.contentEl.empty()}},A=class extends w.Modal{constructor(i,e,s){super(i),this.templates=e,this.onSelect=s}onOpen(){let{contentEl:i}=this;if(i.createEl("h2",{text:"Select Template"}),this.templates.length===0){i.createEl("p",{text:"No templates defined. Add templates in settings.",cls:"block-properties-no-templates"});return}let e=i.createEl("div",{cls:"block-properties-template-list"});for(let s of this.templates){let t=e.createEl("div",{cls:"block-properties-template-item"});t.createEl("div",{text:s.name,cls:"block-properties-template-name"}),t.createEl("div",{text:s.properties.map(n=>`${n.key}: ${n.value||"..."}`).join(", "),cls:"block-properties-template-preview"}),t.addEventListener("click",()=>{this.onSelect(s),this.close()})}}onClose(){this.contentEl.empty()}};var R=class extends x.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Block Properties Settings"}),new x.Setting(i).setName("Display mode").setDesc("How to display block properties in the editor").addDropdown(s=>s.addOption("inline","Inline (dimmed text)").addOption("badge","Badge (compact icon)").setValue(this.plugin.settings.displayMode).onChange(async t=>{this.plugin.settings.displayMode=t,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new x.Setting(i).setName("Property color").setDesc("Color used to display block properties").addText(s=>s.setPlaceholder("#888888").setValue(this.plugin.settings.propertyColor).onChange(async t=>{this.plugin.settings.propertyColor=t||"#888888",await this.plugin.saveSettings(),this.plugin.updateStyles()})),new x.Setting(i).setName("Opacity").setDesc("Opacity of block properties (0.1 - 1.0)").addSlider(s=>s.setLimits(.1,1,.1).setValue(this.plugin.settings.opacity).setDynamicTooltip().onChange(async t=>{this.plugin.settings.opacity=t,await this.plugin.saveSettings(),this.plugin.updateStyles()})),i.createEl("h3",{text:"Linked Properties"}),new x.Setting(i).setName("Enable linked properties").setDesc("Allow property values to contain links to notes ([[Note]]) and blocks (^block-id). Cmd/Ctrl+click to navigate.").addToggle(s=>s.setValue(this.plugin.settings.enableLinkedProperties).onChange(async t=>{this.plugin.settings.enableLinkedProperties=t,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new x.Setting(i).setName("Show backlinks in panel").setDesc('Display a "Referenced by" section in the property panel showing blocks that link to this block').addToggle(s=>s.setValue(this.plugin.settings.showBacklinksInPanel).onChange(async t=>{this.plugin.settings.showBacklinksInPanel=t,await this.plugin.saveSettings()})),i.createEl("h3",{text:"Property Templates"}),new x.Setting(i).setName("Auto-expand presets").setDesc('Automatically expand "preset: name" to full template properties when selected from autocomplete').addToggle(s=>s.setValue(this.plugin.settings.autoExpandPresets).onChange(async t=>{this.plugin.settings.autoExpandPresets=t,await this.plugin.saveSettings()}));let e=i.createEl("div",{cls:"block-properties-templates-container"});this.renderTemplatesList(e)}renderTemplatesList(i){i.empty();for(let e=0;e<this.plugin.settings.templates.length;e++){let s=this.plugin.settings.templates[e];s&&this.renderTemplateItem(i,s,e)}new x.Setting(i).addButton(e=>e.setButtonText("Add template").setCta().onClick(()=>{this.openTemplateModal(null,s=>{this.plugin.settings.templates.push(s),this.plugin.saveSettings(),this.renderTemplatesList(i)})}))}renderTemplateItem(i,e,s){new x.Setting(i).setName(e.name).setDesc(e.properties.map(t=>`${t.key}: ${t.value||"(empty)"}`).join(", ")).addButton(t=>t.setIcon("pencil").setTooltip("Edit").onClick(()=>{this.openTemplateModal(e,n=>{this.plugin.settings.templates[s]=n,this.plugin.saveSettings(),this.renderTemplatesList(i)})})).addButton(t=>t.setIcon("trash").setTooltip("Delete").onClick(async()=>{this.plugin.settings.templates.splice(s,1),await this.plugin.saveSettings(),this.renderTemplatesList(i)}))}openTemplateModal(i,e){new N(this.app,i,e).open()}};var O=require("obsidian");var D=class extends O.EditorSuggest{constructor(e){super(e.app);this.cachedKeys=new Map;this.cachedValues=new Map;this.cachedBlockIds=new Map;this.lastCacheUpdate=0;this.CACHE_TTL=3e4;this.plugin=e}onTrigger(e,s,t){let n=s.getLine(e.line),o=n.slice(0,e.ch),c=n.slice(e.ch),a=o.lastIndexOf("[");if(a===-1)return null;let l=o.slice(a+1);if(l.includes("]")||!n.slice(0,a).match(/\^[\w-]+\s*$/))return null;let r=l.lastIndexOf(","),d=l.lastIndexOf(":"),h,f;return d>r?(h=a+1+d+1,f=l.slice(d+1).trim()):(h=a+1+(r===-1?0:r+1),f=r===-1?l.trim():l.slice(r+1).trim()),{start:{line:e.line,ch:h},end:e,query:f}}async getSuggestions(e){await this.updateCache();let t=e.editor.getLine(e.start.line).slice(0,e.end.ch),n=t.lastIndexOf("["),o=t.slice(n+1),c=o.lastIndexOf(","),a=o.lastIndexOf(":"),l=e.query.toLowerCase();if(a>c){let p=c===-1?0:c+1,r=o.slice(p,a).trim(),d=o.slice(a+1),h=this.detectLinkContext(d);if((h==null?void 0:h.type)==="note")return this.getNoteSuggestions(h.query);if((h==null?void 0:h.type)==="block")return this.getBlockSuggestions(h.query);if(r==="preset")return this.plugin.settings.templates.filter(k=>k.name.toLowerCase().includes(l)).map(k=>({type:"template",text:k.name,count:k.properties.length,template:k}));let f=this.cachedValues.get(r)||new Map;return Array.from(f.entries()).filter(([k])=>k.toLowerCase().includes(l)).map(([k,m])=>({type:"value",text:k,count:m})).sort((k,m)=>m.count-k.count).slice(0,10)}else{let p=Array.from(this.cachedKeys.entries()).filter(([r])=>r.toLowerCase().includes(l)).map(([r,d])=>({type:"key",text:r,count:d})).sort((r,d)=>d.count-r.count).slice(0,10);return"preset".includes(l)&&this.plugin.settings.templates.length>0&&!p.find(r=>r.text==="preset")&&p.unshift({type:"key",text:"preset",count:this.plugin.settings.templates.length}),p}}detectLinkContext(e){let s=e.lastIndexOf("[[");if(s!==-1){let n=e.slice(s+2);if(!n.includes("]]"))return{type:"note",query:n.trim()}}let t=e.lastIndexOf("^");if(t!==-1){let n=e.slice(t+1);if(/^[\w-]*$/.test(n))return{type:"block",query:n}}return null}getNoteSuggestions(e){let s=this.app.vault.getMarkdownFiles(),t=e.toLowerCase();return s.filter(n=>n.basename.toLowerCase().includes(t)).slice(0,10).map(n=>({type:"note-link",text:n.basename,count:0,filePath:n.path}))}getBlockSuggestions(e){let s=e.toLowerCase();return Array.from(this.cachedBlockIds.entries()).filter(([t])=>t.toLowerCase().includes(s)).slice(0,10).map(([t,n])=>{let o=this.app.vault.getAbstractFileByPath(n),c=o instanceof O.TFile?o.basename:n;return{type:"block-ref",text:t,count:0,filePath:c}})}renderSuggestion(e,s){s.addClass("block-properties-suggestion"),s.createEl("span",{text:e.text,cls:"block-properties-suggestion-text"});let t=s.createEl("span",{cls:"block-properties-suggestion-meta"}),n;switch(e.type){case"template":n="template";break;case"key":n="key";break;case"note-link":n="note";break;case"block-ref":n="block";break;default:n="value"}t.createEl("span",{text:n,cls:`block-properties-suggestion-type block-properties-suggestion-type-${e.type}`}),e.type==="note-link"||e.type==="block-ref"?e.filePath&&t.createEl("span",{text:e.filePath,cls:"block-properties-suggestion-path"}):t.createEl("span",{text:`${e.count}`,cls:"block-properties-suggestion-count"}),e.type==="template"&&e.template&&s.createEl("div",{text:e.template.properties.map(o=>`${o.key}: ${o.value||"..."}`).join(", "),cls:"block-properties-suggestion-preview"})}selectSuggestion(e,s){if(!this.context)return;let{editor:t,start:n,end:o}=this.context,c=t.getLine(n.line);if(e.type==="template"&&e.template&&this.plugin.settings.autoExpandPresets){let r=c.lastIndexOf("[",n.ch),d=c.indexOf("]",o.ch);if(r!==-1&&d!==-1){let h=e.template.properties.map(k=>`${k.key}: ${k.value}`).join(", ");t.replaceRange(`[${h}]`,{line:n.line,ch:r},{line:n.line,ch:d+1});let f=r+h.length+2;t.setCursor({line:n.line,ch:f});return}}let a=e.text,l=n;if(e.type==="key")a=e.text+": ";else if(e.type==="note-link"){let d=c.slice(0,o.ch).lastIndexOf("[[");d!==-1&&(l={line:n.line,ch:d},a=`[[${e.text}]]`)}else if(e.type==="block-ref"){let d=c.slice(0,o.ch).lastIndexOf("^");d!==-1&&(l={line:n.line,ch:d},a=`^${e.text}`)}t.replaceRange(a,l,o);let p=l.ch+a.length;t.setCursor({line:n.line,ch:p})}async updateCache(){let e=Date.now();if(e-this.lastCacheUpdate<this.CACHE_TTL)return;this.cachedKeys.clear(),this.cachedValues.clear(),this.cachedBlockIds.clear();let s=this.app.vault.getMarkdownFiles();for(let t of s)try{let o=(await this.app.vault.cachedRead(t)).split(`
`);for(let c of o){let a=y(c);for(let p of a){this.cachedBlockIds.has(p.blockId)||this.cachedBlockIds.set(p.blockId,t.path);for(let r of p.properties){this.cachedKeys.set(r.key,(this.cachedKeys.get(r.key)||0)+1),this.cachedValues.has(r.key)||this.cachedValues.set(r.key,new Map);let d=this.cachedValues.get(r.key);d.set(r.value,(d.get(r.value)||0)+1)}}let l=c.matchAll(/\^([\w-]+)(?!\s*\[)/g);for(let p of l){let r=p[1];r&&!this.cachedBlockIds.has(r)&&this.cachedBlockIds.set(r,t.path)}}}catch(n){}this.lastCacheUpdate=e}getKeys(){return this.cachedKeys}getValuesForKey(e){return this.cachedValues.get(e)||new Map}async refreshCache(){this.lastCacheUpdate=0,await this.updateCache()}};var te={displayMode:"inline",propertyColor:"#888888",opacity:.6,templates:[{name:"task",properties:[{key:"status",value:"todo"},{key:"priority",value:"medium"},{key:"assignee",value:""}]}],autoExpandPresets:!0,enableLinkedProperties:!0,showBacklinksInPanel:!0};var L=require("obsidian");var H=class extends L.Events{constructor(e){super();this.index=new Map;this.fileEventRefs=[];this.isBuilding=!1;this.debounceTimer=null;this.DEBOUNCE_MS=500;this.app=e}async buildIndex(){if(this.isBuilding)return;this.isBuilding=!0,this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let s of e)await this.indexFile(s);this.isBuilding=!1,this.trigger("index-updated")}async indexFile(e){this.removeFileFromIndex(e.path);let t=(await this.app.vault.cachedRead(e)).split(`
`);for(let n=0;n<t.length;n++){let o=t[n];if(!o)continue;let c=y(o);for(let a of c)for(let l of a.properties){let p=I(l.value);for(let r of p.links){let d=r.type==="note"?this.normalizeNotePath(r.target):`^${r.target}`,h={sourceFile:e.path,sourceBlockId:a.blockId,key:l.key,line:n},f=this.index.get(d);f?f.push(h):this.index.set(d,[h])}}}}removeFileFromIndex(e){for(let[s,t]of this.index.entries()){let n=t.filter(o=>o.sourceFile!==e);n.length===0?this.index.delete(s):this.index.set(s,n)}}normalizeNotePath(e){return e.endsWith(".md")?e:`${e}.md`}getBacklinksForBlock(e){return this.index.get(`^${e}`)||[]}getBacklinksForNote(e){return this.index.get(this.normalizeNotePath(e))||[]}async getBacklinksForFile(e){let s=new Map,t=this.getBacklinksForNote(e.path);t.length>0&&s.set(e.basename,t);let n=await this.app.vault.cachedRead(e),o=y(n);for(let c of o){let a=this.getBacklinksForBlock(c.blockId);a.length>0&&s.set(`^${c.blockId}`,a)}return s}registerFileEvents(){this.fileEventRefs.push(this.app.vault.on("modify",e=>{e instanceof L.TFile&&e.extension==="md"&&this.debouncedIndexFile(e)}),this.app.vault.on("delete",e=>{e instanceof L.TFile&&(this.removeFileFromIndex(e.path),this.trigger("index-updated"))}),this.app.vault.on("rename",(e,s)=>{e instanceof L.TFile&&e.extension==="md"&&(this.removeFileFromIndex(s),this.debouncedIndexFile(e))}))}debouncedIndexFile(e){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{await this.indexFile(e),this.trigger("index-updated"),this.debounceTimer=null},this.DEBOUNCE_MS)}unregisterFileEvents(){for(let e of this.fileEventRefs)this.app.vault.offref(e);this.fileEventRefs=[],this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}getStats(){let e=0;for(let s of this.index.values())e+=s.length;return{targets:this.index.size,totalBacklinks:e}}};var q=class extends se.Plugin{constructor(){super(...arguments);this.styleEl=null;this.editorExtension=[];this.suggest=null;this.backlinkIndex=null;this.readingTooltip=null}async onload(){await this.loadSettings(),this.editorExtension=Q(this.settings.displayMode,this.settings.enableLinkedProperties?this.app:void 0),this.registerEditorExtension(this.editorExtension),this.registerView(T,e=>new M(e,this)),this.suggest=new D(this),this.registerEditorSuggest(this.suggest),this.addSettingTab(new R(this.app,this)),this.settings.enableLinkedProperties&&(this.backlinkIndex=new H(this.app),this.backlinkIndex.registerFileEvents(),this.app.workspace.onLayoutReady(()=>{var e;(e=this.backlinkIndex)==null||e.buildIndex()})),this.addCommand({id:"insert-block-property",name:"Insert block property",editorCallback:(e,s)=>{let t=e.getCursor(),n=e.getLine(t.line);if(n.includes("^")){let o=n.match(/\^([\w-]+)(?:\s*\[([^\]]*)\])?/);if(o){let c=o[1],a=o[2]||"",l=a?`${a}, key: value`:"key: value",p=`^${c} [${l}]`,r=n.indexOf("^");e.replaceRange(p,{line:t.line,ch:r},{line:t.line,ch:n.length})}}else e.replaceRange(" ^block-id [key: value]",{line:t.line,ch:n.length})}}),this.addCommand({id:"insert-template",name:"Insert property template",editorCallback:(e,s)=>{new A(this.app,this.settings.templates,t=>{let n=e.getCursor(),o=e.getLine(n.line),c=this.generateBlockId(),a=t.properties.map(p=>`${p.key}: ${p.value}`).join(", "),l=` ^${c} [${a}]`;e.replaceRange(l,{line:n.line,ch:o.length})}).open()}}),this.addCommand({id:"query-block-properties",name:"Query block properties",callback:()=>{new $(this.app,async(e,s)=>{if(!e)return;let t=await ee(this.app,e,s||void 0);new V(this.app,t,{key:e,value:s}).open()}).open()}}),this.addCommand({id:"open-property-panel",name:"Open property panel",callback:()=>{this.activatePanel()}}),this.registerMarkdownPostProcessor(this.postProcessor.bind(this)),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updatePanel()})),this.registerEvent(this.app.workspace.on("editor-change",()=>{this.updatePanel()})),this.updateStyles()}async activatePanel(){let s=this.app.workspace.getLeavesOfType(T)[0];if(s){this.app.workspace.revealLeaf(s);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:T,active:!0}),this.app.workspace.revealLeaf(t))}updatePanel(){let e=this.app.workspace.getLeavesOfType(T);for(let s of e){let t=s.view,n=this.app.workspace.getActiveFile();t.updateForFile(n)}}postProcessor(e,s){let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[],o;for(;o=t.nextNode();){let c=o.textContent||"",a=y(c);a.length>0&&n.push({node:o,props:a})}for(let{node:c,props:a}of n.reverse()){let l=c.textContent||"";for(let p of a.reverse()){let d=l.slice(p.from,p.to).indexOf("[");if(d===-1)continue;let h=l.slice(0,p.from+d),f=l.slice(p.from+d,p.to),k=l.slice(p.to),m=document.createElement("span");m.className="block-property block-property-reading",m.textContent=f,m.setAttribute("data-block-id",p.blockId),m.setAttribute("data-properties",JSON.stringify(p.properties)),m.addEventListener("mouseenter",v=>{this.showReadingTooltip(v.target,p)}),m.addEventListener("mouseleave",()=>{this.hideReadingTooltip()});let g=c.parentNode;if(g){let v=document.createTextNode(h),B=document.createTextNode(k);g.insertBefore(v,c),g.insertBefore(m,c),g.insertBefore(B,c),g.removeChild(c)}}}}showReadingTooltip(e,s){this.hideReadingTooltip();let t=document.createElement("div");t.className="block-properties-tooltip block-properties-reading-tooltip";let n=document.createElement("div");n.className="block-properties-tooltip-header",n.textContent=`^${s.blockId}`,t.appendChild(n);let o=document.createElement("div");o.className="block-properties-tooltip-list";for(let a of s.properties){let l=document.createElement("div");l.className="block-properties-tooltip-item";let p=document.createElement("span");p.className="block-properties-tooltip-key",p.textContent=a.key;let r=document.createElement("span");r.className="block-properties-tooltip-value",r.textContent=a.value,l.appendChild(p),l.appendChild(r),o.appendChild(l)}t.appendChild(o);let c=e.getBoundingClientRect();t.style.position="fixed",t.style.left=`${c.left}px`,t.style.top=`${c.top-8}px`,t.style.transform="translateY(-100%)",t.style.zIndex="1000",document.body.appendChild(t),this.readingTooltip=t}hideReadingTooltip(){this.readingTooltip&&(this.readingTooltip.remove(),this.readingTooltip=null)}onunload(){var e;this.styleEl&&this.styleEl.remove(),(e=this.backlinkIndex)==null||e.unregisterFileEvents()}getBacklinkIndex(){return this.backlinkIndex}async loadSettings(){this.settings=Object.assign({},te,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}updateStyles(){this.styleEl||(this.styleEl=document.createElement("style"),this.styleEl.id="block-properties-styles",document.head.appendChild(this.styleEl)),this.styleEl.textContent=`
			.block-property {
				color: ${this.settings.propertyColor};
				opacity: ${this.settings.opacity};
				font-size: 0.9em;
			}
		`}refreshEditorExtension(){let e=Q(this.settings.displayMode,this.settings.enableLinkedProperties?this.app:void 0);this.editorExtension.length=0,this.editorExtension.push(...e),this.app.workspace.updateOptions()}getSuggest(){return this.suggest}generateBlockId(){let e="abcdefghijklmnopqrstuvwxyz0123456789",s="";for(let t=0;t<6;t++)s+=e.charAt(Math.floor(Math.random()*e.length));return s}};
