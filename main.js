/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var J=(m,o)=>{for(var e in o)D(m,e,{get:o[e],enumerable:!0})},z=(m,o,e,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of W(o))!Q.call(m,t)&&t!==e&&D(m,t,{get:()=>o[t],enumerable:!(s=U(o,t))||s.enumerable});return m};var G=m=>z(D({},"__esModule",{value:!0}),m);var te={};J(te,{default:()=>N});module.exports=G(te);var _=require("obsidian");var H=require("@codemirror/state"),v=require("@codemirror/view");var R=/\^([\w-]+)\s*\[([^\]]+)\]/g;function k(m,o=0){let e=[],s;for(R.lastIndex=0;(s=R.exec(m))!==null;){let t=s[1],r=s[2];if(!t||!r)continue;let n=Y(r);e.push({blockId:t,properties:n,from:o+s.index,to:o+s.index+s[0].length})}return e}function Y(m){let o=[],e=m.split(",");for(let s of e){let t=s.indexOf(":");if(t===-1)continue;let r=s.slice(0,t).trim(),n=s.slice(t+1).trim();r&&o.push({key:r,value:n})}return o}var X=v.Decoration.mark({class:"block-property"}),F=class extends v.WidgetType{constructor(e,s){super();this.blockId=e;this.properties=s}toDOM(){let e=document.createElement("span");e.className="block-property-badge",e.setAttribute("data-block-id",this.blockId),e.setAttribute("data-properties",JSON.stringify(this.properties));let s=this.properties.length;return e.textContent=`${s}`,e.title=this.properties.map(t=>`${t.key}: ${t.value}`).join(", "),e}eq(e){return this.blockId===e.blockId&&JSON.stringify(this.properties)===JSON.stringify(e.properties)}};function Z(m){class o{constructor(s){this.decorations=this.buildDecorations(s)}update(s){(s.docChanged||s.viewportChanged)&&(this.decorations=this.buildDecorations(s.view))}destroy(){}buildDecorations(s){let t=new H.RangeSetBuilder;for(let{from:r,to:n}of s.visibleRanges){let c=s.state.doc.sliceString(r,n),p=k(c,r);for(let i of p){let l=s.state.doc.sliceString(i.from,i.to).indexOf("[");if(l!==-1){let u=i.from+l,d=i.to;if(m==="badge"){let h=new F(i.blockId,i.properties);t.add(u,d,v.Decoration.replace({widget:h}))}else t.add(u,d,X)}}}return t.finish()}}return v.ViewPlugin.fromClass(o,{decorations:e=>e.decorations})}var ee=(0,v.hoverTooltip)((m,o)=>{let e=m.state.doc.lineAt(o),s=e.text,t=e.from,r=k(s,t);for(let n of r){let p=m.state.doc.sliceString(n.from,n.to).indexOf("[");if(p!==-1){let i=n.from+p,a=n.to;if(o>=i&&o<=a)return{pos:i,above:!0,create(){let l=document.createElement("div");l.className="block-properties-tooltip";let u=document.createElement("div");u.className="block-properties-tooltip-header",u.textContent=`^${n.blockId}`,l.appendChild(u);let d=document.createElement("div");d.className="block-properties-tooltip-list";for(let h of n.properties){let f=document.createElement("div");f.className="block-properties-tooltip-item";let g=document.createElement("span");g.className="block-properties-tooltip-key",g.textContent=h.key;let y=document.createElement("span");y.className="block-properties-tooltip-value",y.textContent=h.value,f.appendChild(g),f.appendChild(y),d.appendChild(f)}return l.appendChild(d),{dom:l}}}}}return null});function O(m){return[Z(m),ee]}var P=require("obsidian");var T="block-properties-panel",S=class extends P.ItemView{constructor(e,s){super(e);this.currentFile=null;this.plugin=s}getViewType(){return T}getDisplayText(){return"Block Properties"}getIcon(){return"tag"}async onOpen(){this.renderPanel()}async onClose(){}async updateForFile(e){this.currentFile=e,this.renderPanel()}async renderPanel(){let{contentEl:e}=this;e.empty(),e.addClass("block-properties-panel");let s=e.createEl("div",{cls:"block-properties-panel-header"});if(!this.currentFile){s.createEl("h4",{text:"Block Properties"}),e.createEl("p",{text:"No file open",cls:"block-properties-panel-empty"});return}s.createEl("h4",{text:this.currentFile.basename});let t=await this.app.vault.cachedRead(this.currentFile),r=this.extractBlocks(t);if(r.length===0){e.createEl("p",{text:"No block properties found",cls:"block-properties-panel-empty"});return}let n=e.createEl("p",{cls:"block-properties-panel-count"});n.textContent=`${r.length} block(s) with properties`;let c=e.createEl("div",{cls:"block-properties-panel-list"});for(let l of r){let u=c.createEl("div",{cls:"block-properties-panel-item"}),d=u.createEl("div",{cls:"block-properties-panel-item-header"});d.createEl("a",{text:`^${l.blockId}`,cls:"block-properties-panel-link"}).addEventListener("click",()=>{this.navigateToBlock(l.line)}),l.context&&d.createEl("span",{text:l.context,cls:"block-properties-panel-context"});let f=u.createEl("div",{cls:"block-properties-panel-props"});for(let y of l.properties){let w=f.createEl("div",{cls:"block-properties-panel-prop"});w.createEl("span",{text:y.key,cls:"block-properties-panel-key"});let C=w.createEl("div",{cls:"block-properties-panel-value-container"});C.createEl("span",{text:y.value||"(empty)",cls:`block-properties-panel-value ${y.value?"":"is-empty"}`}).addEventListener("click",()=>{this.startEditingValue(C,l,y.key,y.value)});let A=w.createEl("button",{cls:"block-properties-panel-delete-btn",attr:{"aria-label":"Delete property"}});A.innerHTML="&times;",A.addEventListener("click",()=>{this.deleteProperty(l,y.key)})}let g=f.createEl("button",{text:"+ Add property",cls:"block-properties-panel-add-btn"});g.addEventListener("click",()=>{this.startAddingProperty(f,l,g)})}let p=e.createEl("div",{cls:"block-properties-panel-summary"});p.createEl("h5",{text:"Summary"});let i=this.countKeys(r),a=p.createEl("div",{cls:"block-properties-panel-summary-list"});for(let[l,u]of Object.entries(i)){let d=a.createEl("div",{cls:"block-properties-panel-summary-item"});d.createEl("span",{text:l,cls:"block-properties-panel-summary-key"}),d.createEl("span",{text:`${u}`,cls:"block-properties-panel-summary-count"})}}extractBlocks(e){let s=[],t=e.split(`
`);for(let r=0;r<t.length;r++){let n=t[r];if(!n)continue;let c=k(n);for(let p of c){let i=n.slice(0,p.from).trim().slice(0,40),l=n.slice(p.from,p.to).indexOf("[");s.push({blockId:p.blockId,properties:p.properties,line:r,context:i||"(start of line)",blockStart:p.from,propsStart:p.from+l,propsEnd:p.to-1})}}return s}countKeys(e){let s={};for(let t of e)for(let r of t.properties)s[r.key]=(s[r.key]||0)+1;return s}navigateToBlock(e){let s=this.app.workspace.getActiveViewOfType(P.MarkdownView);if(s){let t=s.editor;t.setCursor({line:e,ch:0}),t.scrollIntoView({from:{line:e,ch:0},to:{line:e,ch:0}},!0),t.focus()}}startEditingValue(e,s,t,r){e.empty();let n=e.createEl("input",{type:"text",value:r,cls:"block-properties-panel-edit-input"}),c=e.createEl("div",{cls:"block-properties-panel-dropdown"});this.populateValueDropdown(c,t,n),n.focus(),n.select(),n.addEventListener("input",()=>{this.populateValueDropdown(c,t,n)});let p=async()=>{let i=n.value.trim();await this.updateProperty(s,t,i)};n.addEventListener("blur",()=>{setTimeout(()=>{e.contains(document.activeElement)||p()},150)}),n.addEventListener("keydown",i=>{i.key==="Enter"?(i.preventDefault(),p()):i.key==="Escape"&&this.renderPanel()})}populateValueDropdown(e,s,t){e.empty();let r=this.plugin.getSuggest();if(!r){e.hide();return}let n=r.getValuesForKey(s),c=t.value.toLowerCase(),p=Array.from(n.entries()).filter(([i])=>i.toLowerCase().includes(c)).sort((i,a)=>a[1]-i[1]).slice(0,5);if(p.length===0){e.hide();return}e.show();for(let[i,a]of p){let l=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});l.createEl("span",{text:i}),l.createEl("span",{text:`${a}`,cls:"block-properties-panel-dropdown-count"}),l.addEventListener("click",()=>{t.value=i,t.focus(),e.hide()})}}startAddingProperty(e,s,t){t.remove();let r=e.createEl("div",{cls:"block-properties-panel-prop block-properties-panel-new-prop"}),n=r.createEl("input",{type:"text",placeholder:"key",cls:"block-properties-panel-edit-input block-properties-panel-key-input"});r.createEl("span",{text:":"});let c=r.createEl("input",{type:"text",placeholder:"value",cls:"block-properties-panel-edit-input"}),p=r.createEl("button",{text:"\u2713",cls:"block-properties-panel-save-btn"}),i=r.createEl("button",{text:"\xD7",cls:"block-properties-panel-cancel-btn"});n.focus();let a=r.createEl("div",{cls:"block-properties-panel-dropdown block-properties-panel-key-dropdown"});n.addEventListener("input",()=>{this.populateKeyDropdown(a,n,c)}),p.addEventListener("click",async()=>{let l=n.value.trim(),u=c.value.trim();l&&await this.addProperty(s,l,u)}),i.addEventListener("click",()=>{this.renderPanel()}),c.addEventListener("keydown",l=>{l.key==="Enter"?p.click():l.key==="Escape"&&i.click()}),n.addEventListener("keydown",l=>{l.key==="Escape"&&i.click()})}populateKeyDropdown(e,s,t){e.empty();let r=this.plugin.getSuggest();if(!r){e.hide();return}let n=r.getKeys(),c=s.value.toLowerCase(),p=Array.from(n.entries()).filter(([i])=>i.toLowerCase().includes(c)).sort((i,a)=>a[1]-i[1]).slice(0,5);if(p.length===0){e.hide();return}e.show();for(let[i,a]of p){let l=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});l.createEl("span",{text:i}),l.createEl("span",{text:`${a}`,cls:"block-properties-panel-dropdown-count"}),l.addEventListener("click",()=>{s.value=i,t.focus(),e.hide()})}}async updateProperty(e,s,t){if(this.currentFile)try{let n=(await this.app.vault.read(this.currentFile)).split(`
`),c=n[e.line];if(!c)return;let i=e.properties.map(d=>d.key===s?{key:s,value:t}:d).map(d=>`${d.key}: ${d.value}`).join(", "),a=c.slice(0,e.propsStart),l=c.slice(e.propsEnd+1),u=`${a}[${i}]${l}`;n[e.line]=u,await this.app.vault.modify(this.currentFile,n.join(`
`)),this.renderPanel()}catch(r){new P.Notice("Failed to update property")}}async addProperty(e,s,t){if(this.currentFile){if(e.properties.find(r=>r.key===s)){await this.updateProperty(e,s,t);return}try{let n=(await this.app.vault.read(this.currentFile)).split(`
`),c=n[e.line];if(!c)return;let i=[...e.properties,{key:s,value:t}].map(d=>`${d.key}: ${d.value}`).join(", "),a=c.slice(0,e.propsStart),l=c.slice(e.propsEnd+1),u=`${a}[${i}]${l}`;n[e.line]=u,await this.app.vault.modify(this.currentFile,n.join(`
`)),this.renderPanel()}catch(r){new P.Notice("Failed to add property")}}}async deleteProperty(e,s){if(this.currentFile)try{let r=(await this.app.vault.read(this.currentFile)).split(`
`),n=r[e.line];if(!n)return;let c=e.properties.filter(p=>p.key!==s);if(c.length===0){let p=n.slice(0,e.blockStart),i=n.slice(e.propsEnd+1),a=n.slice(e.blockStart).match(/^\^[\w-]+/),l=`${p}${(a==null?void 0:a[0])||""}${i}`;r[e.line]=l}else{let p=c.map(u=>`${u.key}: ${u.value}`).join(", "),i=n.slice(0,e.propsStart),a=n.slice(e.propsEnd+1),l=`${i}[${p}]${a}`;r[e.line]=l}await this.app.vault.modify(this.currentFile,r.join(`
`)),this.renderPanel()}catch(t){new P.Notice("Failed to delete property")}}};var E=require("obsidian");var L=class extends E.Modal{constructor(o,e){super(o),this.onSubmit=e}onOpen(){let{contentEl:o}=this;o.addClass("block-properties-query-modal"),o.createEl("h2",{text:"Query Block Properties"});let e="",s="";new E.Setting(o).setName("Property key").setDesc('e.g. "status", "priority", "version"').addText(t=>t.setPlaceholder("status").onChange(r=>{e=r})),new E.Setting(o).setName("Property value (optional)").setDesc("Leave empty to find all blocks with this key").addText(t=>t.setPlaceholder("draft").onChange(r=>{s=r})),new E.Setting(o).addButton(t=>t.setButtonText("Search").setCta().onClick(()=>{this.close(),this.onSubmit(e,s)}))}onClose(){let{contentEl:o}=this;o.empty()}},B=class extends E.Modal{constructor(o,e,s){super(o),this.results=e,this.query=s}onOpen(){let{contentEl:o}=this;o.addClass("block-properties-results-modal");let e=this.query.value?`${this.query.key}: ${this.query.value}`:this.query.key;if(o.createEl("h2",{text:`Results for "${e}"`}),o.createEl("p",{text:`Found ${this.results.length} block(s)`,cls:"block-properties-results-count"}),this.results.length===0){o.createEl("p",{text:"No blocks found with matching properties.",cls:"block-properties-no-results"});return}let s=o.createEl("div",{cls:"block-properties-results-list"});for(let t of this.results){let r=s.createEl("div",{cls:"block-properties-result-item"});r.createEl("div",{cls:"block-properties-result-header"}).createEl("a",{text:`${t.file.basename} \u2192 ^${t.blockId}`,cls:"block-properties-result-link"}).addEventListener("click",async i=>{i.preventDefault(),this.close(),await this.app.workspace.getLeaf().openFile(t.file);let l=this.app.workspace.getActiveViewOfType(E.MarkdownView);if(l){let u=l.editor;u.setCursor({line:t.line,ch:0}),u.scrollIntoView({from:{line:t.line,ch:0},to:{line:t.line,ch:0}},!0)}});let p=r.createEl("div",{cls:"block-properties-result-props"});for(let i of t.properties){let a=i.key===this.query.key&&(!this.query.value||i.value===this.query.value);p.createEl("span",{text:`${i.key}: ${i.value}`,cls:`block-properties-result-prop ${a?"is-match":""}`})}t.context&&r.createEl("div",{text:t.context,cls:"block-properties-result-context"})}}onClose(){let{contentEl:o}=this;o.empty()}};async function q(m,o,e){let s=[],t=m.vault.getMarkdownFiles();for(let r of t){let c=(await m.vault.cachedRead(r)).split(`
`);for(let p=0;p<c.length;p++){let i=c[p];if(!i)continue;let a=k(i);for(let l of a)l.properties.find(d=>d.key===o&&(!e||d.value===e))&&s.push({file:r,line:p,blockId:l.blockId,properties:l.properties,context:i.slice(0,l.from).trim().slice(0,60)})}}return s}var x=require("obsidian");var b=require("obsidian"),M=class extends b.Modal{constructor(o,e,s){super(o),this.isNew=!e,this.template=e?{...e,properties:e.properties.map(t=>({...t}))}:{name:"",properties:[{key:"",value:""}]},this.onSave=s}onOpen(){let{contentEl:o}=this;o.addClass("block-properties-template-modal"),o.createEl("h2",{text:this.isNew?"Create Template":"Edit Template"}),new b.Setting(o).setName("Template name").setDesc('Used in "preset: name" syntax').addText(s=>s.setPlaceholder("task").setValue(this.template.name).onChange(t=>{this.template.name=t.trim().toLowerCase().replace(/\s+/g,"-")})),o.createEl("h4",{text:"Properties"});let e=o.createEl("div",{cls:"block-properties-template-props"});this.renderProperties(e),new b.Setting(o).addButton(s=>s.setButtonText("Cancel").onClick(()=>this.close())).addButton(s=>s.setButtonText("Save").setCta().onClick(()=>{if(!this.template.name){new b.Notice("Template name is required");return}if(this.template.properties=this.template.properties.filter(t=>t.key.trim()),this.template.properties.length===0){new b.Notice("At least one property is required");return}this.onSave(this.template),this.close()}))}renderProperties(o){o.empty();for(let s=0;s<this.template.properties.length;s++){let t=this.template.properties[s];if(!t)continue;let r=o.createEl("div",{cls:"block-properties-template-prop-row"});r.createEl("input",{type:"text",placeholder:"key",value:t.key,cls:"block-properties-template-input"}).addEventListener("input",i=>{t.key=i.target.value}),r.createEl("span",{text:":"}),r.createEl("input",{type:"text",placeholder:"default value",value:t.value,cls:"block-properties-template-input"}).addEventListener("input",i=>{t.value=i.target.value});let p=r.createEl("button",{cls:"block-properties-template-delete-btn"});p.innerHTML="&times;",p.addEventListener("click",()=>{this.template.properties.splice(s,1),this.template.properties.length===0&&this.template.properties.push({key:"",value:""}),this.renderProperties(o)})}o.createEl("button",{text:"+ Add property",cls:"block-properties-template-add-btn"}).addEventListener("click",()=>{this.template.properties.push({key:"",value:""}),this.renderProperties(o)})}onClose(){this.contentEl.empty()}},I=class extends b.Modal{constructor(o,e,s){super(o),this.templates=e,this.onSelect=s}onOpen(){let{contentEl:o}=this;if(o.createEl("h2",{text:"Select Template"}),this.templates.length===0){o.createEl("p",{text:"No templates defined. Add templates in settings.",cls:"block-properties-no-templates"});return}let e=o.createEl("div",{cls:"block-properties-template-list"});for(let s of this.templates){let t=e.createEl("div",{cls:"block-properties-template-item"});t.createEl("div",{text:s.name,cls:"block-properties-template-name"}),t.createEl("div",{text:s.properties.map(r=>`${r.key}: ${r.value||"..."}`).join(", "),cls:"block-properties-template-preview"}),t.addEventListener("click",()=>{this.onSelect(s),this.close()})}}onClose(){this.contentEl.empty()}};var $=class extends x.PluginSettingTab{constructor(o,e){super(o,e),this.plugin=e}display(){let{containerEl:o}=this;o.empty(),o.createEl("h2",{text:"Block Properties Settings"}),new x.Setting(o).setName("Display mode").setDesc("How to display block properties in the editor").addDropdown(s=>s.addOption("inline","Inline (dimmed text)").addOption("badge","Badge (compact icon)").setValue(this.plugin.settings.displayMode).onChange(async t=>{this.plugin.settings.displayMode=t,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new x.Setting(o).setName("Property color").setDesc("Color used to display block properties").addText(s=>s.setPlaceholder("#888888").setValue(this.plugin.settings.propertyColor).onChange(async t=>{this.plugin.settings.propertyColor=t||"#888888",await this.plugin.saveSettings(),this.plugin.updateStyles()})),new x.Setting(o).setName("Opacity").setDesc("Opacity of block properties (0.1 - 1.0)").addSlider(s=>s.setLimits(.1,1,.1).setValue(this.plugin.settings.opacity).setDynamicTooltip().onChange(async t=>{this.plugin.settings.opacity=t,await this.plugin.saveSettings(),this.plugin.updateStyles()})),o.createEl("h3",{text:"Property Templates"}),new x.Setting(o).setName("Auto-expand presets").setDesc('Automatically expand "preset: name" to full template properties when selected from autocomplete').addToggle(s=>s.setValue(this.plugin.settings.autoExpandPresets).onChange(async t=>{this.plugin.settings.autoExpandPresets=t,await this.plugin.saveSettings()}));let e=o.createEl("div",{cls:"block-properties-templates-container"});this.renderTemplatesList(e)}renderTemplatesList(o){o.empty();for(let e=0;e<this.plugin.settings.templates.length;e++){let s=this.plugin.settings.templates[e];s&&this.renderTemplateItem(o,s,e)}new x.Setting(o).addButton(e=>e.setButtonText("Add template").setCta().onClick(()=>{this.openTemplateModal(null,s=>{this.plugin.settings.templates.push(s),this.plugin.saveSettings(),this.renderTemplatesList(o)})}))}renderTemplateItem(o,e,s){new x.Setting(o).setName(e.name).setDesc(e.properties.map(t=>`${t.key}: ${t.value||"(empty)"}`).join(", ")).addButton(t=>t.setIcon("pencil").setTooltip("Edit").onClick(()=>{this.openTemplateModal(e,r=>{this.plugin.settings.templates[s]=r,this.plugin.saveSettings(),this.renderTemplatesList(o)})})).addButton(t=>t.setIcon("trash").setTooltip("Delete").onClick(async()=>{this.plugin.settings.templates.splice(s,1),await this.plugin.saveSettings(),this.renderTemplatesList(o)}))}openTemplateModal(o,e){new M(this.app,o,e).open()}};var K=require("obsidian");var V=class extends K.EditorSuggest{constructor(e){super(e.app);this.cachedKeys=new Map;this.cachedValues=new Map;this.lastCacheUpdate=0;this.CACHE_TTL=3e4;this.plugin=e}onTrigger(e,s,t){let r=s.getLine(e.line),n=r.slice(0,e.ch),c=r.slice(e.ch),p=n.lastIndexOf("[");if(p===-1)return null;let i=n.slice(p+1);if(i.includes("]")||!r.slice(0,p).match(/\^[\w-]+\s*$/))return null;let l=i.lastIndexOf(","),u=i.lastIndexOf(":"),d,h;return u>l?(d=p+1+u+1,h=i.slice(u+1).trim()):(d=p+1+(l===-1?0:l+1),h=l===-1?i.trim():i.slice(l+1).trim()),{start:{line:e.line,ch:d},end:e,query:h}}async getSuggestions(e){await this.updateCache();let t=e.editor.getLine(e.start.line).slice(0,e.end.ch),r=t.lastIndexOf("["),n=t.slice(r+1),c=n.lastIndexOf(","),p=n.lastIndexOf(":"),i=e.query.toLowerCase();if(p>c){let a=c===-1?0:c+1,l=n.slice(a,p).trim();if(l==="preset")return this.plugin.settings.templates.filter(d=>d.name.toLowerCase().includes(i)).map(d=>({type:"template",text:d.name,count:d.properties.length,template:d}));let u=this.cachedValues.get(l)||new Map;return Array.from(u.entries()).filter(([d])=>d.toLowerCase().includes(i)).map(([d,h])=>({type:"value",text:d,count:h})).sort((d,h)=>h.count-d.count).slice(0,10)}else{let a=Array.from(this.cachedKeys.entries()).filter(([l])=>l.toLowerCase().includes(i)).map(([l,u])=>({type:"key",text:l,count:u})).sort((l,u)=>u.count-l.count).slice(0,10);return"preset".includes(i)&&this.plugin.settings.templates.length>0&&!a.find(l=>l.text==="preset")&&a.unshift({type:"key",text:"preset",count:this.plugin.settings.templates.length}),a}}renderSuggestion(e,s){s.addClass("block-properties-suggestion"),s.createEl("span",{text:e.text,cls:"block-properties-suggestion-text"});let t=s.createEl("span",{cls:"block-properties-suggestion-meta"}),r;e.type==="template"?r="template":e.type==="key"?r="key":r="value",t.createEl("span",{text:r,cls:`block-properties-suggestion-type block-properties-suggestion-type-${e.type}`}),t.createEl("span",{text:`${e.count}`,cls:"block-properties-suggestion-count"}),e.type==="template"&&e.template&&s.createEl("div",{text:e.template.properties.map(n=>`${n.key}: ${n.value||"..."}`).join(", "),cls:"block-properties-suggestion-preview"})}selectSuggestion(e,s){if(!this.context)return;let{editor:t,start:r,end:n}=this.context,c=t.getLine(r.line);if(e.type==="template"&&e.template&&this.plugin.settings.autoExpandPresets){let a=c.lastIndexOf("[",r.ch),l=c.indexOf("]",n.ch);if(a!==-1&&l!==-1){let u=e.template.properties.map(h=>`${h.key}: ${h.value}`).join(", ");t.replaceRange(`[${u}]`,{line:r.line,ch:a},{line:r.line,ch:l+1});let d=a+u.length+2;t.setCursor({line:r.line,ch:d});return}}let p=e.text;e.type==="key"&&(p=e.text+": "),t.replaceRange(p,r,n);let i=r.ch+p.length;t.setCursor({line:r.line,ch:i})}async updateCache(){let e=Date.now();if(e-this.lastCacheUpdate<this.CACHE_TTL)return;this.cachedKeys.clear(),this.cachedValues.clear();let s=this.app.vault.getMarkdownFiles();for(let t of s)try{let n=(await this.app.vault.cachedRead(t)).split(`
`);for(let c of n){let p=k(c);for(let i of p)for(let a of i.properties){this.cachedKeys.set(a.key,(this.cachedKeys.get(a.key)||0)+1),this.cachedValues.has(a.key)||this.cachedValues.set(a.key,new Map);let l=this.cachedValues.get(a.key);l.set(a.value,(l.get(a.value)||0)+1)}}}catch(r){}this.lastCacheUpdate=e}getKeys(){return this.cachedKeys}getValuesForKey(e){return this.cachedValues.get(e)||new Map}async refreshCache(){this.lastCacheUpdate=0,await this.updateCache()}};var j={displayMode:"inline",propertyColor:"#888888",opacity:.6,templates:[{name:"task",properties:[{key:"status",value:"todo"},{key:"priority",value:"medium"},{key:"assignee",value:""}]}],autoExpandPresets:!0};var N=class extends _.Plugin{constructor(){super(...arguments);this.styleEl=null;this.editorExtension=[];this.suggest=null;this.readingTooltip=null}async onload(){await this.loadSettings(),this.editorExtension=O(this.settings.displayMode),this.registerEditorExtension(this.editorExtension),this.registerView(T,e=>new S(e,this)),this.suggest=new V(this),this.registerEditorSuggest(this.suggest),this.addSettingTab(new $(this.app,this)),this.addCommand({id:"insert-block-property",name:"Insert block property",editorCallback:(e,s)=>{let t=e.getCursor(),r=e.getLine(t.line);if(r.includes("^")){let n=r.match(/\^([\w-]+)(?:\s*\[([^\]]*)\])?/);if(n){let c=n[1],p=n[2]||"",i=p?`${p}, key: value`:"key: value",a=`^${c} [${i}]`,l=r.indexOf("^");e.replaceRange(a,{line:t.line,ch:l},{line:t.line,ch:r.length})}}else e.replaceRange(" ^block-id [key: value]",{line:t.line,ch:r.length})}}),this.addCommand({id:"insert-template",name:"Insert property template",editorCallback:(e,s)=>{new I(this.app,this.settings.templates,t=>{let r=e.getCursor(),n=e.getLine(r.line),c=this.generateBlockId(),p=t.properties.map(a=>`${a.key}: ${a.value}`).join(", "),i=` ^${c} [${p}]`;e.replaceRange(i,{line:r.line,ch:n.length})}).open()}}),this.addCommand({id:"query-block-properties",name:"Query block properties",callback:()=>{new L(this.app,async(e,s)=>{if(!e)return;let t=await q(this.app,e,s||void 0);new B(this.app,t,{key:e,value:s}).open()}).open()}}),this.addCommand({id:"open-property-panel",name:"Open property panel",callback:()=>{this.activatePanel()}}),this.registerMarkdownPostProcessor(this.postProcessor.bind(this)),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updatePanel()})),this.registerEvent(this.app.workspace.on("editor-change",()=>{this.updatePanel()})),this.updateStyles()}async activatePanel(){let s=this.app.workspace.getLeavesOfType(T)[0];if(s){this.app.workspace.revealLeaf(s);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:T,active:!0}),this.app.workspace.revealLeaf(t))}updatePanel(){let e=this.app.workspace.getLeavesOfType(T);for(let s of e){let t=s.view,r=this.app.workspace.getActiveFile();t.updateForFile(r)}}postProcessor(e,s){let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),r=[],n;for(;n=t.nextNode();){let c=n.textContent||"",p=k(c);p.length>0&&r.push({node:n,props:p})}for(let{node:c,props:p}of r.reverse()){let i=c.textContent||"";for(let a of p.reverse()){let u=i.slice(a.from,a.to).indexOf("[");if(u===-1)continue;let d=i.slice(0,a.from+u),h=i.slice(a.from+u,a.to),f=i.slice(a.to),g=document.createElement("span");g.className="block-property block-property-reading",g.textContent=h,g.setAttribute("data-block-id",a.blockId),g.setAttribute("data-properties",JSON.stringify(a.properties)),g.addEventListener("mouseenter",w=>{this.showReadingTooltip(w.target,a)}),g.addEventListener("mouseleave",()=>{this.hideReadingTooltip()});let y=c.parentNode;if(y){let w=document.createTextNode(d),C=document.createTextNode(f);y.insertBefore(w,c),y.insertBefore(g,c),y.insertBefore(C,c),y.removeChild(c)}}}}showReadingTooltip(e,s){this.hideReadingTooltip();let t=document.createElement("div");t.className="block-properties-tooltip block-properties-reading-tooltip";let r=document.createElement("div");r.className="block-properties-tooltip-header",r.textContent=`^${s.blockId}`,t.appendChild(r);let n=document.createElement("div");n.className="block-properties-tooltip-list";for(let p of s.properties){let i=document.createElement("div");i.className="block-properties-tooltip-item";let a=document.createElement("span");a.className="block-properties-tooltip-key",a.textContent=p.key;let l=document.createElement("span");l.className="block-properties-tooltip-value",l.textContent=p.value,i.appendChild(a),i.appendChild(l),n.appendChild(i)}t.appendChild(n);let c=e.getBoundingClientRect();t.style.position="fixed",t.style.left=`${c.left}px`,t.style.top=`${c.top-8}px`,t.style.transform="translateY(-100%)",t.style.zIndex="1000",document.body.appendChild(t),this.readingTooltip=t}hideReadingTooltip(){this.readingTooltip&&(this.readingTooltip.remove(),this.readingTooltip=null)}onunload(){this.styleEl&&this.styleEl.remove()}async loadSettings(){this.settings=Object.assign({},j,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}updateStyles(){this.styleEl||(this.styleEl=document.createElement("style"),this.styleEl.id="block-properties-styles",document.head.appendChild(this.styleEl)),this.styleEl.textContent=`
			.block-property {
				color: ${this.settings.propertyColor};
				opacity: ${this.settings.opacity};
				font-size: 0.9em;
			}
		`}refreshEditorExtension(){let e=O(this.settings.displayMode);this.editorExtension.length=0,this.editorExtension.push(...e),this.app.workspace.updateOptions()}getSuggest(){return this.suggest}generateBlockId(){let e="abcdefghijklmnopqrstuvwxyz0123456789",s="";for(let t=0;t<6;t++)s+=e.charAt(Math.floor(Math.random()*e.length));return s}};
