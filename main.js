/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var W=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var de=Object.prototype.hasOwnProperty;var he=(u,n)=>{for(var e in n)W(u,e,{get:n[e],enumerable:!0})},me=(u,n,e,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of ue(n))!de.call(u,t)&&t!==e&&W(u,t,{get:()=>n[t],enumerable:!(s=pe(n,t))||s.enumerable});return u};var ge=u=>me(W({},"__esModule",{value:!0}),u);var Le={};he(Le,{default:()=>z});module.exports=ge(Le);var ce=require("obsidian");var X=require("@codemirror/state"),x=require("@codemirror/view");var se=/\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g,ie=/\^([\w-]+)/g;function $(u){var s;let n=[];se.lastIndex=0;let e;for(;(e=se.exec(u))!==null;){let t=e[1];!t||t.trim()===""||n.push({type:"note",raw:e[0],target:t.trim(),alias:(s=e[2])==null?void 0:s.trim()})}for(ie.lastIndex=0;(e=ie.exec(u))!==null;){let t=e[1];if(!t)continue;let i=e.index;n.some(l=>{if(l.type!=="note")return!1;let a=u.indexOf(l.raw),c=a+l.raw.length;return i>=a&&i<c})||n.push({type:"block",raw:e[0],target:t})}return{raw:u,links:n}}function F(u){let n=$(u),e=[];for(let s of n.links){let t=0,i;for(;(i=u.indexOf(s.raw,t))!==-1;){if(!e.some(l=>l.from===i&&l.link.raw===s.raw)){e.push({from:i,to:i+s.raw.length,link:s});break}t=i+1}}return e.sort((s,t)=>s.from-t.from),e}var ne=/\^([\w-]+)\s*\[([^\]]+)\]/g;function E(u,n=0){let e=[],s;for(ne.lastIndex=0;(s=ne.exec(u))!==null;){let t=s[1],i=s[2];if(!t||!i)continue;let o=ke(i);e.push({blockId:t,properties:o,from:n+s.index,to:n+s.index+s[0].length})}return e}function ke(u){let n=[],e=u.split(",");for(let s of e){let t=s.indexOf(":");if(t===-1)continue;let i=s.slice(0,t).trim(),o=s.slice(t+1).trim();if(i){let l=$(o);n.push({key:i,value:o,parsedValue:l})}}return n}function fe(u,n,e){let s=u.metadataCache.getFirstLinkpathDest(n,e);return{file:s,exists:s!==null}}async function ye(u,n,e,s=!0){if(e){let t=await u.vault.cachedRead(e),i=oe(t,n);if(i!==-1)return{file:e,blockId:n,line:i,exists:!0}}if(s)for(let t of u.vault.getMarkdownFiles()){if(t===e)continue;let i=await u.vault.cachedRead(t),o=oe(i,n);if(o!==-1)return{file:t,blockId:n,line:o,exists:!0}}return{file:null,exists:!1}}function oe(u,n){let e=u.split(`
`),s=new RegExp(`\\^${n}(?:\\s|\\[|$)`);for(let t=0;t<e.length;t++){let i=e[t];if(i&&s.test(i))return t}return-1}async function N(u,n,e,s){if(n.type==="note"){let t=fe(u,n.target,e);if(t.file)return await u.workspace.getLeaf().openFile(t.file),!0}else if(n.type==="block"){let t=await ye(u,n.target,s);if(t.file&&t.line!==void 0){let i=u.workspace.getLeaf();await i.openFile(t.file);let o=i.view;return o.getViewType()==="markdown"&&setTimeout(()=>{let l=o.editor;l&&(l.setCursor({line:t.line,ch:0}),l.scrollIntoView({from:{line:t.line,ch:0},to:{line:t.line,ch:0}},!0))},100),!0}}return!1}function re(u){return u.toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}function ve(u){let n=[];for(let e of u){let s=re(e.key),t=re(e.value);!s||!t||n.push(`bp-${s}-${t}`)}return n}function be(u,n){let e=[];for(let s of n)u.find(i=>i.key===s.key&&(s.value==="*"||i.value===s.value))&&s.className&&e.push(s.className);return e}function I(u,n){if(!n.enableConditionalStyling)return[];let e=ve(u),s=be(u,n.customStyleRules);return[...e,...s]}var J=class extends x.WidgetType{constructor(e,s,t=[]){super();this.blockId=e;this.properties=s;this.conditionalClasses=t}toDOM(){let e=document.createElement("span");e.className=["block-property-badge",...this.conditionalClasses].join(" "),e.setAttribute("data-block-id",this.blockId),e.setAttribute("data-properties",JSON.stringify(this.properties));let s=this.properties.length;return e.textContent=`${s}`,e.title=this.properties.map(t=>`${t.key}: ${t.value}`).join(", "),e}eq(e){return this.blockId===e.blockId&&JSON.stringify(this.properties)===JSON.stringify(e.properties)&&JSON.stringify(this.conditionalClasses)===JSON.stringify(e.conditionalClasses)}};function Ee(u,n){class e{constructor(t){this.decorations=this.buildDecorations(t)}update(t){(t.docChanged||t.viewportChanged)&&(this.decorations=this.buildDecorations(t.view))}destroy(){}buildDecorations(t){let i=new X.RangeSetBuilder,o=[];for(let{from:l,to:a}of t.visibleRanges){let c=t.state.doc.sliceString(l,a),p=E(c,l);for(let r of p){let h=t.state.doc.sliceString(r.from,r.to).indexOf("[");if(h!==-1){let k=r.from+h,m=r.to,f=I(r.properties,n);if(n.enableConditionalStyling&&n.stylingTarget==="line"&&f.length>0){let g=t.state.doc.lineAt(r.from);o.push({from:g.from,to:g.from,decoration:x.Decoration.line({class:["bp-styled-line",...f].join(" ")})})}if(u==="badge"){let g=new J(r.blockId,r.properties,f);o.push({from:k,to:m,decoration:x.Decoration.replace({widget:g})})}else{let g=["block-property",...f];o.push({from:k,to:m,decoration:x.Decoration.mark({class:g.join(" ")})})}}}}o.sort((l,a)=>l.from-a.from||l.to-a.to);for(let l of o)i.add(l.from,l.to,l.decoration);return i.finish()}}return x.ViewPlugin.fromClass(e,{decorations:s=>s.decorations})}var xe=(0,x.hoverTooltip)((u,n)=>{let e=u.state.doc.lineAt(n),s=e.text,t=e.from,i=E(s,t);for(let o of i){let a=u.state.doc.sliceString(o.from,o.to).indexOf("[");if(a!==-1){let c=o.from+a,p=o.to;if(n>=c&&n<=p)return{pos:c,above:!0,create(){let r=document.createElement("div");r.className="block-properties-tooltip";let d=document.createElement("div");d.className="block-properties-tooltip-header",d.textContent=`^${o.blockId}`,r.appendChild(d);let h=document.createElement("div");h.className="block-properties-tooltip-list";for(let k of o.properties){let m=document.createElement("div");m.className="block-properties-tooltip-item";let f=document.createElement("span");f.className="block-properties-tooltip-key",f.textContent=k.key;let g=document.createElement("span");g.className="block-properties-tooltip-value",g.textContent=k.value,m.appendChild(f),m.appendChild(g),h.appendChild(m)}return r.appendChild(h),{dom:r}}}}}return null}),we=x.Decoration.mark({class:"block-property-link"}),G=new WeakMap;function Pe(){class u{constructor(e){this.linkPositions=[];let s=this.buildLinkDecorations(e);this.decorations=s.decorations,this.linkPositions=s.positions,G.set(e,this.linkPositions)}update(e){if(e.docChanged||e.viewportChanged){let s=this.buildLinkDecorations(e.view);this.decorations=s.decorations,this.linkPositions=s.positions,G.set(e.view,this.linkPositions)}}destroy(){}buildLinkDecorations(e){let s=new X.RangeSetBuilder,t=[];for(let{from:i,to:o}of e.visibleRanges){let l=e.state.doc.sliceString(i,o),a=E(l,i);for(let c of a){let p=e.state.doc.sliceString(c.from,c.to),r=p.indexOf("["),d=p.lastIndexOf("]");if(r===-1||d===-1)continue;let h=p.slice(r+1,d),k=c.from+r+1,m=0;for(let f of c.properties){let g=`${f.key}: ${f.value}`,b=h.indexOf(g,m);if(b===-1)continue;let P=b+f.key.length+2,T=k+P,B=F(f.value);for(let L of B){let ee=T+L.from,te=T+L.to;s.add(ee,te,we),t.push({from:ee,to:te,link:L.link})}m=b+g.length}}}return{decorations:s.finish(),positions:t}}}return x.ViewPlugin.fromClass(u,{decorations:n=>n.decorations})}function Ce(u){return x.EditorView.domEventHandlers({click:(n,e)=>{if(!n.metaKey&&!n.ctrlKey)return!1;let s=e.posAtCoords({x:n.clientX,y:n.clientY});if(s===null)return!1;let t=G.get(e);if(!t)return!1;for(let i of t)if(s>=i.from&&s<=i.to){n.preventDefault();let o=u.workspace.getActiveFile(),l=(o==null?void 0:o.path)||"";return N(u,i.link,l,o||void 0),!0}return!1}})}function Y(u,n,e){let s=[Ee(u,n),xe];return e&&(s.push(Pe()),s.push(Ce(e))),s}var w=require("obsidian");var R="block-properties-panel",M=class extends w.ItemView{constructor(e,s){super(e);this.currentFile=null;this.plugin=s}getViewType(){return R}getDisplayText(){return"Block Properties"}getIcon(){return"tag"}async onOpen(){this.renderPanel()}async onClose(){}async updateForFile(e){this.currentFile=e,this.renderPanel()}async renderPanel(){let{contentEl:e}=this;e.empty(),e.addClass("block-properties-panel");let s=e.createEl("div",{cls:"block-properties-panel-header"});if(!this.currentFile){s.createEl("h4",{text:"Block Properties"}),e.createEl("p",{text:"No file open",cls:"block-properties-panel-empty"});return}s.createEl("h4",{text:this.currentFile.basename});let t=await this.app.vault.cachedRead(this.currentFile),i=this.extractBlocks(t);if(i.length===0){e.createEl("p",{text:"No block properties found",cls:"block-properties-panel-empty"});return}let o=e.createEl("p",{cls:"block-properties-panel-count"});o.textContent=`${i.length} block(s) with properties`;let l=e.createEl("div",{cls:"block-properties-panel-list"});for(let r of i){let h=["block-properties-panel-item",...I(r.properties,this.plugin.settings)],k=l.createEl("div",{cls:h.join(" ")}),m=k.createEl("div",{cls:"block-properties-panel-item-header"});m.createEl("a",{text:`^${r.blockId}`,cls:"block-properties-panel-link"}).addEventListener("click",()=>{this.navigateToBlock(r.line)}),r.context&&m.createEl("span",{text:r.context,cls:"block-properties-panel-context"});let g=k.createEl("div",{cls:"block-properties-panel-props"});for(let P of r.properties){let T=g.createEl("div",{cls:"block-properties-panel-prop"});T.createEl("span",{text:P.key,cls:"block-properties-panel-key"});let B=T.createEl("div",{cls:"block-properties-panel-value-container"});this.renderPropertyValue(B,P.value,r,P.key);let L=T.createEl("button",{cls:"block-properties-panel-delete-btn",attr:{"aria-label":"Delete property"}});L.innerHTML="&times;",L.addEventListener("click",()=>{this.deleteProperty(r,P.key)})}let b=g.createEl("button",{text:"+ Add property",cls:"block-properties-panel-add-btn"});b.addEventListener("click",()=>{this.startAddingProperty(g,r,b)})}this.plugin.settings.showBacklinksInPanel&&await this.renderBacklinks(e,i);let a=e.createEl("div",{cls:"block-properties-panel-summary"});a.createEl("h5",{text:"Summary"});let c=this.countKeys(i),p=a.createEl("div",{cls:"block-properties-panel-summary-list"});for(let[r,d]of Object.entries(c)){let h=p.createEl("div",{cls:"block-properties-panel-summary-item"});h.createEl("span",{text:r,cls:"block-properties-panel-summary-key"}),h.createEl("span",{text:`${d}`,cls:"block-properties-panel-summary-count"})}}extractBlocks(e){let s=[],t=e.split(`
`);for(let i=0;i<t.length;i++){let o=t[i];if(!o)continue;let l=E(o);for(let a of l){let c=o.slice(0,a.from).trim().slice(0,40),r=o.slice(a.from,a.to).indexOf("[");s.push({blockId:a.blockId,properties:a.properties,line:i,context:c||"(start of line)",blockStart:a.from,propsStart:a.from+r,propsEnd:a.to-1})}}return s}countKeys(e){let s={};for(let t of e)for(let i of t.properties)s[i.key]=(s[i.key]||0)+1;return s}navigateToBlock(e){let s=this.app.workspace.getActiveViewOfType(w.MarkdownView);if(s){let t=s.editor;t.setCursor({line:e,ch:0}),t.scrollIntoView({from:{line:e,ch:0},to:{line:e,ch:0}},!0),t.focus()}}renderPropertyValue(e,s,t,i){if(!s){e.createEl("span",{text:"(empty)",cls:"block-properties-panel-value is-empty"}).addEventListener("click",()=>{this.startEditingValue(e,t,i,s)});return}let o=F(s);if(o.length===0){e.createEl("span",{text:s,cls:"block-properties-panel-value"}).addEventListener("click",()=>{this.startEditingValue(e,t,i,s)});return}let l=e.createEl("span",{cls:"block-properties-panel-value block-properties-panel-value-with-links"}),a=0;for(let p of o)p.from>a&&l.createEl("span",{text:s.slice(a,p.from)}).addEventListener("click",()=>{this.startEditingValue(e,t,i,s)}),l.createEl("a",{text:p.link.alias||p.link.target,cls:`block-properties-panel-link-value block-properties-link-${p.link.type}`}).addEventListener("click",async d=>{var m;d.stopPropagation();let h=((m=this.currentFile)==null?void 0:m.path)||"";await N(this.app,p.link,h,this.currentFile||void 0)||new w.Notice(`Could not find ${p.link.type==="note"?"note":"block"}: ${p.link.target}`)}),a=p.to;a<s.length&&l.createEl("span",{text:s.slice(a)}).addEventListener("click",()=>{this.startEditingValue(e,t,i,s)}),l.createEl("span",{text:" \u270E",cls:"block-properties-panel-edit-icon"}).addEventListener("click",()=>{this.startEditingValue(e,t,i,s)})}async renderBacklinks(e,s){let t=this.plugin.getBacklinkIndex();if(!t)return;let i=[];for(let l of s){let a=t.getBacklinksForBlock(l.blockId);a.length>0&&i.push({targetId:`^${l.blockId}`,entries:a})}if(i.length===0)return;let o=e.createEl("div",{cls:"block-properties-panel-backlinks"});o.createEl("h5",{text:"Referenced by"});for(let{targetId:l,entries:a}of i){o.createEl("div",{cls:"block-properties-panel-backlinks-target"}).createEl("span",{text:l,cls:"block-properties-panel-backlinks-target-id"});let p=o.createEl("div",{cls:"block-properties-panel-backlinks-list"});for(let r of a){let d=p.createEl("div",{cls:"block-properties-panel-backlinks-item"}),h=this.app.vault.getAbstractFileByPath(r.sourceFile),k=h instanceof w.TFile?`${h.basename} \u2192 ^${r.sourceBlockId}`:`${r.sourceFile} \u2192 ^${r.sourceBlockId}`;d.createEl("a",{text:k,cls:"block-properties-panel-backlinks-link"}).addEventListener("click",async()=>{h instanceof w.TFile&&(await this.app.workspace.getLeaf().openFile(h),setTimeout(()=>{let g=this.app.workspace.getActiveViewOfType(w.MarkdownView);if(g){let b=g.editor;b.setCursor({line:r.line,ch:0}),b.scrollIntoView({from:{line:r.line,ch:0},to:{line:r.line,ch:0}},!0)}},100))}),d.createEl("span",{text:` (${r.key})`,cls:"block-properties-panel-backlinks-key"})}}}startEditingValue(e,s,t,i){e.empty();let o=e.createEl("input",{type:"text",value:i,cls:"block-properties-panel-edit-input"}),l=e.createEl("div",{cls:"block-properties-panel-dropdown"});this.populateValueDropdown(l,t,o),o.focus(),o.select(),o.addEventListener("input",()=>{this.populateValueDropdown(l,t,o)});let a=async()=>{let c=o.value.trim();await this.updateProperty(s,t,c)};o.addEventListener("blur",()=>{setTimeout(()=>{e.contains(document.activeElement)||a()},150)}),o.addEventListener("keydown",c=>{c.key==="Enter"?(c.preventDefault(),a()):c.key==="Escape"&&this.renderPanel()})}populateValueDropdown(e,s,t){e.empty();let i=this.plugin.getSuggest();if(!i){e.hide();return}let o=i.getValuesForKey(s),l=t.value.toLowerCase(),a=Array.from(o.entries()).filter(([c])=>c.toLowerCase().includes(l)).sort((c,p)=>p[1]-c[1]).slice(0,5);if(a.length===0){e.hide();return}e.show();for(let[c,p]of a){let r=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});r.createEl("span",{text:c}),r.createEl("span",{text:`${p}`,cls:"block-properties-panel-dropdown-count"}),r.addEventListener("click",()=>{t.value=c,t.focus(),e.hide()})}}startAddingProperty(e,s,t){t.remove();let i=e.createEl("div",{cls:"block-properties-panel-prop block-properties-panel-new-prop"}),o=i.createEl("input",{type:"text",placeholder:"key",cls:"block-properties-panel-edit-input block-properties-panel-key-input"});i.createEl("span",{text:":"});let l=i.createEl("input",{type:"text",placeholder:"value",cls:"block-properties-panel-edit-input"}),a=i.createEl("button",{text:"\u2713",cls:"block-properties-panel-save-btn"}),c=i.createEl("button",{text:"\xD7",cls:"block-properties-panel-cancel-btn"});o.focus();let p=i.createEl("div",{cls:"block-properties-panel-dropdown block-properties-panel-key-dropdown"});o.addEventListener("input",()=>{this.populateKeyDropdown(p,o,l)}),a.addEventListener("click",async()=>{let r=o.value.trim(),d=l.value.trim();r&&await this.addProperty(s,r,d)}),c.addEventListener("click",()=>{this.renderPanel()}),l.addEventListener("keydown",r=>{r.key==="Enter"?a.click():r.key==="Escape"&&c.click()}),o.addEventListener("keydown",r=>{r.key==="Escape"&&c.click()})}populateKeyDropdown(e,s,t){e.empty();let i=this.plugin.getSuggest();if(!i){e.hide();return}let o=i.getKeys(),l=s.value.toLowerCase(),a=Array.from(o.entries()).filter(([c])=>c.toLowerCase().includes(l)).sort((c,p)=>p[1]-c[1]).slice(0,5);if(a.length===0){e.hide();return}e.show();for(let[c,p]of a){let r=e.createEl("div",{cls:"block-properties-panel-dropdown-item"});r.createEl("span",{text:c}),r.createEl("span",{text:`${p}`,cls:"block-properties-panel-dropdown-count"}),r.addEventListener("click",()=>{s.value=c,t.focus(),e.hide()})}}async updateProperty(e,s,t){if(this.currentFile)try{let o=(await this.app.vault.read(this.currentFile)).split(`
`),l=o[e.line];if(!l)return;let c=e.properties.map(h=>h.key===s?{key:s,value:t}:h).map(h=>`${h.key}: ${h.value}`).join(", "),p=l.slice(0,e.propsStart),r=l.slice(e.propsEnd+1),d=`${p}[${c}]${r}`;o[e.line]=d,await this.app.vault.modify(this.currentFile,o.join(`
`)),this.renderPanel()}catch(i){new w.Notice("Failed to update property")}}async addProperty(e,s,t){if(this.currentFile){if(e.properties.find(i=>i.key===s)){await this.updateProperty(e,s,t);return}try{let o=(await this.app.vault.read(this.currentFile)).split(`
`),l=o[e.line];if(!l)return;let c=[...e.properties,{key:s,value:t}].map(h=>`${h.key}: ${h.value}`).join(", "),p=l.slice(0,e.propsStart),r=l.slice(e.propsEnd+1),d=`${p}[${c}]${r}`;o[e.line]=d,await this.app.vault.modify(this.currentFile,o.join(`
`)),this.renderPanel()}catch(i){new w.Notice("Failed to add property")}}}async deleteProperty(e,s){if(this.currentFile)try{let i=(await this.app.vault.read(this.currentFile)).split(`
`),o=i[e.line];if(!o)return;let l=e.properties.filter(a=>a.key!==s);if(l.length===0){let a=o.slice(0,e.blockStart),c=o.slice(e.propsEnd+1),p=o.slice(e.blockStart).match(/^\^[\w-]+/),r=`${a}${(p==null?void 0:p[0])||""}${c}`;i[e.line]=r}else{let a=l.map(d=>`${d.key}: ${d.value}`).join(", "),c=o.slice(0,e.propsStart),p=o.slice(e.propsEnd+1),r=`${c}[${a}]${p}`;i[e.line]=r}await this.app.vault.modify(this.currentFile,i.join(`
`)),this.renderPanel()}catch(t){new w.Notice("Failed to delete property")}}};var C=require("obsidian");var A=class extends C.Modal{constructor(n,e){super(n),this.onSubmit=e}onOpen(){let{contentEl:n}=this;n.addClass("block-properties-query-modal"),n.createEl("h2",{text:"Query Block Properties"});let e="",s="";new C.Setting(n).setName("Property key").setDesc('e.g. "status", "priority", "version"').addText(t=>t.setPlaceholder("status").onChange(i=>{e=i})),new C.Setting(n).setName("Property value (optional)").setDesc("Leave empty to find all blocks with this key").addText(t=>t.setPlaceholder("draft").onChange(i=>{s=i})),new C.Setting(n).addButton(t=>t.setButtonText("Search").setCta().onClick(()=>{this.close(),this.onSubmit(e,s)}))}onClose(){let{contentEl:n}=this;n.empty()}},D=class extends C.Modal{constructor(n,e,s){super(n),this.results=e,this.query=s}onOpen(){let{contentEl:n}=this;n.addClass("block-properties-results-modal");let e=this.query.value?`${this.query.key}: ${this.query.value}`:this.query.key;if(n.createEl("h2",{text:`Results for "${e}"`}),n.createEl("p",{text:`Found ${this.results.length} block(s)`,cls:"block-properties-results-count"}),this.results.length===0){n.createEl("p",{text:"No blocks found with matching properties.",cls:"block-properties-no-results"});return}let s=n.createEl("div",{cls:"block-properties-results-list"});for(let t of this.results){let i=s.createEl("div",{cls:"block-properties-result-item"});i.createEl("div",{cls:"block-properties-result-header"}).createEl("a",{text:`${t.file.basename} \u2192 ^${t.blockId}`,cls:"block-properties-result-link"}).addEventListener("click",async c=>{c.preventDefault(),this.close(),await this.app.workspace.getLeaf().openFile(t.file);let r=this.app.workspace.getActiveViewOfType(C.MarkdownView);if(r){let d=r.editor;d.setCursor({line:t.line,ch:0}),d.scrollIntoView({from:{line:t.line,ch:0},to:{line:t.line,ch:0}},!0)}});let a=i.createEl("div",{cls:"block-properties-result-props"});for(let c of t.properties){let p=c.key===this.query.key&&(!this.query.value||c.value===this.query.value);a.createEl("span",{text:`${c.key}: ${c.value}`,cls:`block-properties-result-prop ${p?"is-match":""}`})}t.context&&i.createEl("div",{text:t.context,cls:"block-properties-result-context"})}}onClose(){let{contentEl:n}=this;n.empty()}};async function O(u,n,e){let s=[],t=u.vault.getMarkdownFiles();for(let i of t){let l=(await u.vault.cachedRead(i)).split(`
`);for(let a=0;a<l.length;a++){let c=l[a];if(!c)continue;let p=E(c);for(let r of p)r.properties.find(h=>h.key===n&&(!e||h.value===e))&&s.push({file:i,line:a,blockId:r.blockId,properties:r.properties,context:c.slice(0,r.from).trim().slice(0,60)})}}return s}var y=require("obsidian");var S=require("obsidian"),K=class extends S.Modal{constructor(n,e,s){super(n),this.isNew=!e,this.template=e?{...e,properties:e.properties.map(t=>({...t}))}:{name:"",properties:[{key:"",value:""}]},this.onSave=s}onOpen(){let{contentEl:n}=this;n.addClass("block-properties-template-modal"),n.createEl("h2",{text:this.isNew?"Create Template":"Edit Template"}),new S.Setting(n).setName("Template name").setDesc('Used in "preset: name" syntax').addText(s=>s.setPlaceholder("task").setValue(this.template.name).onChange(t=>{this.template.name=t.trim().toLowerCase().replace(/\s+/g,"-")})),n.createEl("h4",{text:"Properties"});let e=n.createEl("div",{cls:"block-properties-template-props"});this.renderProperties(e),new S.Setting(n).addButton(s=>s.setButtonText("Cancel").onClick(()=>this.close())).addButton(s=>s.setButtonText("Save").setCta().onClick(()=>{if(!this.template.name){new S.Notice("Template name is required");return}if(this.template.properties=this.template.properties.filter(t=>t.key.trim()),this.template.properties.length===0){new S.Notice("At least one property is required");return}this.onSave(this.template),this.close()}))}renderProperties(n){n.empty();for(let s=0;s<this.template.properties.length;s++){let t=this.template.properties[s];if(!t)continue;let i=n.createEl("div",{cls:"block-properties-template-prop-row"});i.createEl("input",{type:"text",placeholder:"key",value:t.key,cls:"block-properties-template-input"}).addEventListener("input",c=>{t.key=c.target.value}),i.createEl("span",{text:":"}),i.createEl("input",{type:"text",placeholder:"default value",value:t.value,cls:"block-properties-template-input"}).addEventListener("input",c=>{t.value=c.target.value});let a=i.createEl("button",{cls:"block-properties-template-delete-btn"});a.innerHTML="&times;",a.addEventListener("click",()=>{this.template.properties.splice(s,1),this.template.properties.length===0&&this.template.properties.push({key:"",value:""}),this.renderProperties(n)})}n.createEl("button",{text:"+ Add property",cls:"block-properties-template-add-btn"}).addEventListener("click",()=>{this.template.properties.push({key:"",value:""}),this.renderProperties(n)})}onClose(){this.contentEl.empty()}},H=class extends S.Modal{constructor(n,e,s){super(n),this.templates=e,this.onSelect=s}onOpen(){let{contentEl:n}=this;if(n.createEl("h2",{text:"Select Template"}),this.templates.length===0){n.createEl("p",{text:"No templates defined. Add templates in settings.",cls:"block-properties-no-templates"});return}let e=n.createEl("div",{cls:"block-properties-template-list"});for(let s of this.templates){let t=e.createEl("div",{cls:"block-properties-template-item"});t.createEl("div",{text:s.name,cls:"block-properties-template-name"}),t.createEl("div",{text:s.properties.map(i=>`${i.key}: ${i.value||"..."}`).join(", "),cls:"block-properties-template-preview"}),t.addEventListener("click",()=>{this.onSelect(s),this.close()})}}onClose(){this.contentEl.empty()}};var le=require("obsidian"),q=class extends y.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Block Properties Settings"}),new y.Setting(n).setName("Display mode").setDesc("How to display block properties in the editor").addDropdown(t=>t.addOption("inline","Inline (dimmed text)").addOption("badge","Badge (compact icon)").setValue(this.plugin.settings.displayMode).onChange(async i=>{this.plugin.settings.displayMode=i,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new y.Setting(n).setName("Property color").setDesc("Color used to display block properties").addText(t=>t.setPlaceholder("#888888").setValue(this.plugin.settings.propertyColor).onChange(async i=>{this.plugin.settings.propertyColor=i||"#888888",await this.plugin.saveSettings(),this.plugin.updateStyles()})),new y.Setting(n).setName("Opacity").setDesc("Opacity of block properties (0.1 - 1.0)").addSlider(t=>t.setLimits(.1,1,.1).setValue(this.plugin.settings.opacity).setDynamicTooltip().onChange(async i=>{this.plugin.settings.opacity=i,await this.plugin.saveSettings(),this.plugin.updateStyles()})),n.createEl("h3",{text:"Linked Properties"}),new y.Setting(n).setName("Enable linked properties").setDesc("Allow property values to contain links to notes ([[Note]]) and blocks (^block-id). Cmd/Ctrl+click to navigate.").addToggle(t=>t.setValue(this.plugin.settings.enableLinkedProperties).onChange(async i=>{this.plugin.settings.enableLinkedProperties=i,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new y.Setting(n).setName("Show backlinks in panel").setDesc('Display a "Referenced by" section in the property panel showing blocks that link to this block').addToggle(t=>t.setValue(this.plugin.settings.showBacklinksInPanel).onChange(async i=>{this.plugin.settings.showBacklinksInPanel=i,await this.plugin.saveSettings()})),n.createEl("h3",{text:"Conditional Styling"}),new y.Setting(n).setName("Enable conditional styling").setDesc("Add CSS classes based on property values (e.g., bp-status-done). This enables visual styling of blocks based on their properties.").addToggle(t=>t.setValue(this.plugin.settings.enableConditionalStyling).onChange(async i=>{this.plugin.settings.enableConditionalStyling=i,await this.plugin.saveSettings(),this.plugin.updateStyles(),this.plugin.refreshEditorExtension()})),new y.Setting(n).setName("Styling target").setDesc("Apply styles to the property text only, or to the entire line").addDropdown(t=>t.addOption("property","Property only").addOption("line","Entire line").setValue(this.plugin.settings.stylingTarget).onChange(async i=>{this.plugin.settings.stylingTarget=i,await this.plugin.saveSettings(),this.plugin.refreshEditorExtension()})),new y.Setting(n).setName("Use preset styles").setDesc("Apply built-in visual styles for common properties (status: done = strikethrough, priority: high = red accent, etc.)").addToggle(t=>t.setValue(this.plugin.settings.usePresetStyles).onChange(async i=>{this.plugin.settings.usePresetStyles=i,await this.plugin.saveSettings(),this.plugin.updateStyles()}));let e=n.createEl("div",{cls:"block-properties-rules-container"});this.renderCustomRulesList(e),n.createEl("h3",{text:"Property Templates"}),new y.Setting(n).setName("Auto-expand presets").setDesc('Automatically expand "preset: name" to full template properties when selected from autocomplete').addToggle(t=>t.setValue(this.plugin.settings.autoExpandPresets).onChange(async i=>{this.plugin.settings.autoExpandPresets=i,await this.plugin.saveSettings()}));let s=n.createEl("div",{cls:"block-properties-templates-container"});this.renderTemplatesList(s)}renderTemplatesList(n){n.empty();for(let e=0;e<this.plugin.settings.templates.length;e++){let s=this.plugin.settings.templates[e];s&&this.renderTemplateItem(n,s,e)}new y.Setting(n).addButton(e=>e.setButtonText("Add template").setCta().onClick(()=>{this.openTemplateModal(null,s=>{this.plugin.settings.templates.push(s),this.plugin.saveSettings(),this.renderTemplatesList(n)})}))}renderTemplateItem(n,e,s){new y.Setting(n).setName(e.name).setDesc(e.properties.map(t=>`${t.key}: ${t.value||"(empty)"}`).join(", ")).addButton(t=>t.setIcon("pencil").setTooltip("Edit").onClick(()=>{this.openTemplateModal(e,i=>{this.plugin.settings.templates[s]=i,this.plugin.saveSettings(),this.renderTemplatesList(n)})})).addButton(t=>t.setIcon("trash").setTooltip("Delete").onClick(async()=>{this.plugin.settings.templates.splice(s,1),await this.plugin.saveSettings(),this.renderTemplatesList(n)}))}openTemplateModal(n,e){new K(this.app,n,e).open()}renderCustomRulesList(n){n.empty();let e=this.plugin.settings.customStyleRules;if(e.length>0){let s=n.createEl("p",{cls:"setting-item-description",text:"Custom rules for applying CSS classes based on property values:"});s.style.marginBottom="8px"}for(let s=0;s<e.length;s++){let t=e[s];t&&this.renderRuleItem(n,t,s)}new y.Setting(n).setName("Add custom style rule").setDesc("Add a rule to apply a CSS class when a property matches a condition").addButton(s=>s.setButtonText("Add rule").onClick(()=>{this.openRuleModal(null,t=>{this.plugin.settings.customStyleRules.push(t),this.plugin.saveSettings(),this.plugin.refreshEditorExtension(),this.renderCustomRulesList(n)})}))}renderRuleItem(n,e,s){let t=e.value==="*"?"(any value)":e.value;new y.Setting(n).setName(`${e.key}: ${t}`).setDesc(`\u2192 ${e.className}`).addButton(i=>i.setIcon("pencil").setTooltip("Edit").onClick(()=>{this.openRuleModal(e,o=>{this.plugin.settings.customStyleRules[s]=o,this.plugin.saveSettings(),this.plugin.refreshEditorExtension(),this.renderRuleItem(n,o,s)})})).addButton(i=>i.setIcon("trash").setTooltip("Delete").onClick(async()=>{this.plugin.settings.customStyleRules.splice(s,1),await this.plugin.saveSettings(),this.plugin.refreshEditorExtension(),this.renderCustomRulesList(n)}))}openRuleModal(n,e){new Z(this.app,n,e).open()}},Z=class extends le.Modal{constructor(n,e,s){super(n),this.existing=e,this.onSave=s}onOpen(){let{contentEl:n}=this;n.empty(),n.createEl("h2",{text:this.existing?"Edit Style Rule":"New Style Rule"}),new y.Setting(n).setName("Property key").setDesc('The property key to match (e.g., "status")').addText(e=>{var s;this.keyInput=e,e.setValue(((s=this.existing)==null?void 0:s.key)||""),e.inputEl.placeholder="status"}),new y.Setting(n).setName("Property value").setDesc('The value to match, or "*" to match any value').addText(e=>{var s;this.valueInput=e,e.setValue(((s=this.existing)==null?void 0:s.value)||""),e.inputEl.placeholder="done or *"}),new y.Setting(n).setName("CSS class").setDesc("The CSS class to apply when the rule matches").addText(e=>{var s;this.classInput=e,e.setValue(((s=this.existing)==null?void 0:s.className)||""),e.inputEl.placeholder="my-custom-class"}),new y.Setting(n).addButton(e=>e.setButtonText("Cancel").onClick(()=>this.close())).addButton(e=>e.setButtonText("Save").setCta().onClick(()=>{let s=this.keyInput.getValue().trim(),t=this.valueInput.getValue().trim(),i=this.classInput.getValue().trim();!s||!t||!i||(this.onSave({key:s,value:t,className:i}),this.close())}))}onClose(){this.contentEl.empty()}};var _=require("obsidian");var j=class extends _.EditorSuggest{constructor(e){super(e.app);this.cachedKeys=new Map;this.cachedValues=new Map;this.cachedBlockIds=new Map;this.lastCacheUpdate=0;this.CACHE_TTL=3e4;this.plugin=e}onTrigger(e,s,t){let i=s.getLine(e.line),o=i.slice(0,e.ch),l=i.slice(e.ch),a=o.lastIndexOf("[");if(a===-1)return null;let c=o.slice(a+1);if(c.includes("]")||!i.slice(0,a).match(/\^[\w-]+\s*$/))return null;let r=c.lastIndexOf(","),d=c.lastIndexOf(":"),h,k;return d>r?(h=a+1+d+1,k=c.slice(d+1).trim()):(h=a+1+(r===-1?0:r+1),k=r===-1?c.trim():c.slice(r+1).trim()),{start:{line:e.line,ch:h},end:e,query:k}}async getSuggestions(e){await this.updateCache();let t=e.editor.getLine(e.start.line).slice(0,e.end.ch),i=t.lastIndexOf("["),o=t.slice(i+1),l=o.lastIndexOf(","),a=o.lastIndexOf(":"),c=e.query.toLowerCase();if(a>l){let p=l===-1?0:l+1,r=o.slice(p,a).trim(),d=o.slice(a+1),h=this.detectLinkContext(d);if((h==null?void 0:h.type)==="note")return this.getNoteSuggestions(h.query);if((h==null?void 0:h.type)==="block")return this.getBlockSuggestions(h.query);if(r==="preset")return this.plugin.settings.templates.filter(m=>m.name.toLowerCase().includes(c)).map(m=>({type:"template",text:m.name,count:m.properties.length,template:m}));let k=this.cachedValues.get(r)||new Map;return Array.from(k.entries()).filter(([m])=>m.toLowerCase().includes(c)).map(([m,f])=>({type:"value",text:m,count:f})).sort((m,f)=>f.count-m.count).slice(0,10)}else{let p=Array.from(this.cachedKeys.entries()).filter(([r])=>r.toLowerCase().includes(c)).map(([r,d])=>({type:"key",text:r,count:d})).sort((r,d)=>d.count-r.count).slice(0,10);return"preset".includes(c)&&this.plugin.settings.templates.length>0&&!p.find(r=>r.text==="preset")&&p.unshift({type:"key",text:"preset",count:this.plugin.settings.templates.length}),p}}detectLinkContext(e){let s=e.lastIndexOf("[[");if(s!==-1){let i=e.slice(s+2);if(!i.includes("]]"))return{type:"note",query:i.trim()}}let t=e.lastIndexOf("^");if(t!==-1){let i=e.slice(t+1);if(/^[\w-]*$/.test(i))return{type:"block",query:i}}return null}getNoteSuggestions(e){let s=this.app.vault.getMarkdownFiles(),t=e.toLowerCase();return s.filter(i=>i.basename.toLowerCase().includes(t)).slice(0,10).map(i=>({type:"note-link",text:i.basename,count:0,filePath:i.path}))}getBlockSuggestions(e){let s=e.toLowerCase();return Array.from(this.cachedBlockIds.entries()).filter(([t])=>t.toLowerCase().includes(s)).slice(0,10).map(([t,i])=>{let o=this.app.vault.getAbstractFileByPath(i),l=o instanceof _.TFile?o.basename:i;return{type:"block-ref",text:t,count:0,filePath:l}})}renderSuggestion(e,s){s.addClass("block-properties-suggestion"),s.createEl("span",{text:e.text,cls:"block-properties-suggestion-text"});let t=s.createEl("span",{cls:"block-properties-suggestion-meta"}),i;switch(e.type){case"template":i="template";break;case"key":i="key";break;case"note-link":i="note";break;case"block-ref":i="block";break;default:i="value"}t.createEl("span",{text:i,cls:`block-properties-suggestion-type block-properties-suggestion-type-${e.type}`}),e.type==="note-link"||e.type==="block-ref"?e.filePath&&t.createEl("span",{text:e.filePath,cls:"block-properties-suggestion-path"}):t.createEl("span",{text:`${e.count}`,cls:"block-properties-suggestion-count"}),e.type==="template"&&e.template&&s.createEl("div",{text:e.template.properties.map(o=>`${o.key}: ${o.value||"..."}`).join(", "),cls:"block-properties-suggestion-preview"})}selectSuggestion(e,s){if(!this.context)return;let{editor:t,start:i,end:o}=this.context,l=t.getLine(i.line);if(e.type==="template"&&e.template&&this.plugin.settings.autoExpandPresets){let r=l.lastIndexOf("[",i.ch),d=l.indexOf("]",o.ch);if(r!==-1&&d!==-1){let h=e.template.properties.map(m=>`${m.key}: ${m.value}`).join(", ");t.replaceRange(`[${h}]`,{line:i.line,ch:r},{line:i.line,ch:d+1});let k=r+h.length+2;t.setCursor({line:i.line,ch:k});return}}let a=e.text,c=i;if(e.type==="key")a=e.text+": ";else if(e.type==="note-link"){let d=l.slice(0,o.ch).lastIndexOf("[[");d!==-1&&(c={line:i.line,ch:d},a=`[[${e.text}]]`)}else if(e.type==="block-ref"){let d=l.slice(0,o.ch).lastIndexOf("^");d!==-1&&(c={line:i.line,ch:d},a=`^${e.text}`)}t.replaceRange(a,c,o);let p=c.ch+a.length;t.setCursor({line:i.line,ch:p})}async updateCache(){let e=Date.now();if(e-this.lastCacheUpdate<this.CACHE_TTL)return;this.cachedKeys.clear(),this.cachedValues.clear(),this.cachedBlockIds.clear();let s=this.app.vault.getMarkdownFiles();for(let t of s)try{let o=(await this.app.vault.cachedRead(t)).split(`
`);for(let l of o){let a=E(l);for(let p of a){this.cachedBlockIds.has(p.blockId)||this.cachedBlockIds.set(p.blockId,t.path);for(let r of p.properties){this.cachedKeys.set(r.key,(this.cachedKeys.get(r.key)||0)+1),this.cachedValues.has(r.key)||this.cachedValues.set(r.key,new Map);let d=this.cachedValues.get(r.key);d.set(r.value,(d.get(r.value)||0)+1)}}let c=l.matchAll(/\^([\w-]+)(?!\s*\[)/g);for(let p of c){let r=p[1];r&&!this.cachedBlockIds.has(r)&&this.cachedBlockIds.set(r,t.path)}}}catch(i){}this.lastCacheUpdate=e}getKeys(){return this.cachedKeys}getValuesForKey(e){return this.cachedValues.get(e)||new Map}async refreshCache(){this.lastCacheUpdate=0,await this.updateCache()}invalidateCache(){this.lastCacheUpdate=0}};var ae={displayMode:"inline",propertyColor:"#888888",opacity:.6,templates:[{name:"task",properties:[{key:"status",value:"todo"},{key:"priority",value:"medium"},{key:"assignee",value:""}]}],autoExpandPresets:!0,enableLinkedProperties:!0,showBacklinksInPanel:!0,enableConditionalStyling:!0,stylingTarget:"property",usePresetStyles:!0,customStyleRules:[]};var V=require("obsidian");var U=class extends V.Events{constructor(e){super();this.index=new Map;this.fileEventRefs=[];this.isBuilding=!1;this.debounceTimer=null;this.DEBOUNCE_MS=500;this.app=e}async buildIndex(){if(this.isBuilding)return;this.isBuilding=!0,this.index.clear();let e=this.app.vault.getMarkdownFiles();for(let s of e)await this.indexFile(s);this.isBuilding=!1,this.trigger("index-updated")}async indexFile(e){this.removeFileFromIndex(e.path);let t=(await this.app.vault.cachedRead(e)).split(`
`);for(let i=0;i<t.length;i++){let o=t[i];if(!o)continue;let l=E(o);for(let a of l)for(let c of a.properties){let p=$(c.value);for(let r of p.links){let d=r.type==="note"?this.normalizeNotePath(r.target):`^${r.target}`,h={sourceFile:e.path,sourceBlockId:a.blockId,key:c.key,line:i},k=this.index.get(d);k?k.push(h):this.index.set(d,[h])}}}}removeFileFromIndex(e){for(let[s,t]of this.index.entries()){let i=t.filter(o=>o.sourceFile!==e);i.length===0?this.index.delete(s):this.index.set(s,i)}}normalizeNotePath(e){return e.endsWith(".md")?e:`${e}.md`}getBacklinksForBlock(e){return this.index.get(`^${e}`)||[]}getBacklinksForNote(e){return this.index.get(this.normalizeNotePath(e))||[]}async getBacklinksForFile(e){let s=new Map,t=this.getBacklinksForNote(e.path);t.length>0&&s.set(e.basename,t);let i=await this.app.vault.cachedRead(e),o=E(i);for(let l of o){let a=this.getBacklinksForBlock(l.blockId);a.length>0&&s.set(`^${l.blockId}`,a)}return s}registerFileEvents(){this.fileEventRefs.push(this.app.vault.on("modify",e=>{e instanceof V.TFile&&e.extension==="md"&&this.debouncedIndexFile(e)}),this.app.vault.on("delete",e=>{e instanceof V.TFile&&(this.removeFileFromIndex(e.path),this.trigger("index-updated"))}),this.app.vault.on("rename",(e,s)=>{e instanceof V.TFile&&e.extension==="md"&&(this.removeFileFromIndex(s),this.debouncedIndexFile(e))}))}debouncedIndexFile(e){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{await this.indexFile(e),this.trigger("index-updated"),this.debounceTimer=null},this.DEBOUNCE_MS)}unregisterFileEvents(){for(let e of this.fileEventRefs)this.app.vault.offref(e);this.fileEventRefs=[],this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}getStats(){let e=0;for(let s of this.index.values())e+=s.length;return{targets:this.index.size,totalBacklinks:e}}};var v=require("obsidian");function Se(u){return u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Te(u,n,e){let s=new RegExp(`(${Se(n)}:\\s*)([^,\\]]+)`);return u.replace(s,`$1${e}`)}async function Be(u,n,e,s){let t=new Map;for(let l of n){let a=l.file.path;t.has(a)||t.set(a,[]),t.get(a).push(l)}let i=0,o=0;for(let[l,a]of t)try{let c=u.vault.getAbstractFileByPath(l);if(!(c instanceof v.TFile)){o+=a.length;continue}let r=(await u.vault.read(c)).split(`
`);a.sort((d,h)=>h.line-d.line);for(let d of a){let h=r[d.line];if(!h){o++;continue}r[d.line]=Te(h,e,s),i++}await u.vault.modify(c,r.join(`
`))}catch(c){o+=a.length}return{success:i,failed:o}}var Q=class extends v.Modal{constructor(e,s){super(e);this.selectedKey="";this.currentValue="";this.newValue="";this.previewResults=[];this.previewEl=null;this.applyBtn=null;this.plugin=s}onOpen(){let{contentEl:e}=this;e.addClass("block-properties-bulk-edit-modal"),e.empty(),e.createEl("h2",{text:"Bulk Edit Properties"});let s=this.plugin.getSuggest(),t=s?Array.from(s.getKeys().keys()):[];new v.Setting(e).setName("Property key").setDesc("Select the property key to edit").addDropdown(o=>{o.addOption("","-- Select key --");for(let l of t.sort())o.addOption(l,l);o.setValue(this.selectedKey),o.onChange(l=>{this.selectedKey=l,this.clearPreview()})}),new v.Setting(e).setName("Current value").setDesc("Leave empty to match any value").addText(o=>{o.setPlaceholder("(any value)"),o.setValue(this.currentValue),o.onChange(l=>{this.currentValue=l,this.clearPreview()})}),new v.Setting(e).setName("New value").setDesc("The value to set for all matching properties").addText(o=>{o.setPlaceholder("Enter new value"),o.setValue(this.newValue),o.onChange(l=>{this.newValue=l})}),new v.Setting(e).addButton(o=>{o.setButtonText("Preview Changes"),o.onClick(async()=>{await this.loadPreview()})}),this.previewEl=e.createEl("div",{cls:"block-properties-bulk-preview-container"});let i=new v.Setting(e);i.addButton(o=>{o.setButtonText("Cancel"),o.onClick(()=>this.close())}),i.addButton(o=>{this.applyBtn=o.buttonEl,o.setButtonText("Apply Changes"),o.setCta(),o.setDisabled(!0),o.onClick(async()=>{await this.applyChanges()})})}onClose(){this.contentEl.empty()}clearPreview(){this.previewResults=[],this.previewEl&&this.previewEl.empty(),this.applyBtn&&(this.applyBtn.disabled=!0)}async loadPreview(){if(!this.selectedKey){new v.Notice("Please select a property key");return}this.previewEl&&(this.previewEl.empty(),this.previewEl.createEl("p",{text:"Searching...",cls:"block-properties-bulk-loading"}),this.previewResults=await O(this.app,this.selectedKey,this.currentValue||void 0),this.renderPreview())}renderPreview(){if(!this.previewEl)return;this.previewEl.empty();let e=this.previewResults.length,s=this.previewEl.createEl("p",{cls:"block-properties-bulk-count"});if(e===0){s.textContent="No blocks found matching the criteria",this.applyBtn&&(this.applyBtn.disabled=!0);return}let t=this.currentValue?`${this.selectedKey}: ${this.currentValue}`:this.selectedKey;s.textContent=`${e} block(s) with "${t}" will be updated`,this.applyBtn&&(this.applyBtn.disabled=!this.newValue);let i=this.previewEl.createEl("div",{cls:"block-properties-bulk-preview"}),o=this.previewResults.slice(0,20);for(let l of o){let a=i.createEl("div",{cls:"block-properties-bulk-preview-item"});a.createEl("div",{text:`${l.file.basename} \u2192 ^${l.blockId}`,cls:"block-properties-bulk-preview-file"});let c=a.createEl("div",{cls:"block-properties-bulk-preview-change"}),p=l.properties.find(k=>k.key===this.selectedKey),r=(p==null?void 0:p.value)||"",d=c.createEl("span",{text:`${this.selectedKey}: ${r}`,cls:"block-properties-bulk-preview-old"});c.createEl("span",{text:" \u2192 "});let h=c.createEl("span",{text:`${this.selectedKey}: ${this.newValue||"(empty)"}`,cls:"block-properties-bulk-preview-new"})}this.previewResults.length>20&&i.createEl("div",{text:`... and ${this.previewResults.length-20} more`,cls:"block-properties-bulk-preview-more"})}async applyChanges(){if(!this.selectedKey||this.previewResults.length===0){new v.Notice("Nothing to update");return}if(!this.newValue){new v.Notice("Please enter a new value");return}if(this.currentValue&&this.currentValue===this.newValue){new v.Notice("New value is the same as current value");return}let e=await Be(this.app,this.previewResults,this.selectedKey,this.newValue);e.failed===0?new v.Notice(`Updated ${e.success} block(s)`):new v.Notice(`Updated ${e.success} block(s), ${e.failed} failed`);let s=this.plugin.getSuggest();s&&s.invalidateCache(),this.close()}};var z=class extends ce.Plugin{constructor(){super(...arguments);this.styleEl=null;this.editorExtension=[];this.suggest=null;this.backlinkIndex=null;this.readingTooltip=null}async onload(){await this.loadSettings(),this.editorExtension=Y(this.settings.displayMode,this.settings,this.settings.enableLinkedProperties?this.app:void 0),this.registerEditorExtension(this.editorExtension),this.registerView(R,e=>new M(e,this)),this.suggest=new j(this),this.registerEditorSuggest(this.suggest),this.addSettingTab(new q(this.app,this)),this.settings.enableLinkedProperties&&(this.backlinkIndex=new U(this.app),this.backlinkIndex.registerFileEvents(),this.app.workspace.onLayoutReady(()=>{var e;(e=this.backlinkIndex)==null||e.buildIndex()})),this.addCommand({id:"insert-block-property",name:"Insert block property",editorCallback:(e,s)=>{let t=e.getCursor(),i=e.getLine(t.line);if(i.includes("^")){let o=i.match(/\^([\w-]+)(?:\s*\[([^\]]*)\])?/);if(o){let l=o[1],a=o[2]||"",c=a?`${a}, key: value`:"key: value",p=`^${l} [${c}]`,r=i.indexOf("^");e.replaceRange(p,{line:t.line,ch:r},{line:t.line,ch:i.length})}}else e.replaceRange(" ^block-id [key: value]",{line:t.line,ch:i.length})}}),this.addCommand({id:"insert-template",name:"Insert property template",editorCallback:(e,s)=>{new H(this.app,this.settings.templates,t=>{let i=e.getCursor(),o=e.getLine(i.line),l=this.generateBlockId(),a=t.properties.map(p=>`${p.key}: ${p.value}`).join(", "),c=` ^${l} [${a}]`;e.replaceRange(c,{line:i.line,ch:o.length})}).open()}}),this.addCommand({id:"query-block-properties",name:"Query block properties",callback:()=>{new A(this.app,async(e,s)=>{if(!e)return;let t=await O(this.app,e,s||void 0);new D(this.app,t,{key:e,value:s}).open()}).open()}}),this.addCommand({id:"open-property-panel",name:"Open property panel",callback:()=>{this.activatePanel()}}),this.addCommand({id:"bulk-edit-properties",name:"Bulk edit properties",callback:()=>{new Q(this.app,this).open()}}),this.registerMarkdownPostProcessor(this.postProcessor.bind(this)),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.updatePanel()})),this.registerEvent(this.app.workspace.on("editor-change",()=>{this.updatePanel()})),this.updateStyles()}async activatePanel(){let s=this.app.workspace.getLeavesOfType(R)[0];if(s){this.app.workspace.revealLeaf(s);return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:R,active:!0}),this.app.workspace.revealLeaf(t))}updatePanel(){let e=this.app.workspace.getLeavesOfType(R);for(let s of e){let t=s.view,i=this.app.workspace.getActiveFile();t.updateForFile(i)}}postProcessor(e,s){let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),i=[],o;for(;o=t.nextNode();){let l=o.textContent||"",a=E(l);a.length>0&&i.push({node:o,props:a})}for(let{node:l,props:a}of i.reverse()){let c=l.textContent||"";for(let p of a.reverse()){let d=c.slice(p.from,p.to).indexOf("[");if(d===-1)continue;let h=c.slice(0,p.from+d),k=c.slice(p.from+d,p.to),m=c.slice(p.to),f=I(p.properties,this.settings),g=document.createElement("span");g.className=["block-property","block-property-reading",...f].join(" "),g.textContent=k,g.setAttribute("data-block-id",p.blockId),g.setAttribute("data-properties",JSON.stringify(p.properties)),g.addEventListener("mouseenter",P=>{this.showReadingTooltip(P.target,p)}),g.addEventListener("mouseleave",()=>{this.hideReadingTooltip()});let b=l.parentNode;if(b){let P=document.createTextNode(h),T=document.createTextNode(m);if(b.insertBefore(P,l),b.insertBefore(g,l),b.insertBefore(T,l),b.removeChild(l),this.settings.enableConditionalStyling&&this.settings.stylingTarget==="line"&&f.length>0){let B=g.closest("p, li, div.markdown-preview-sizer > div");B&&B.classList.add("bp-styled-line",...f)}}}}}showReadingTooltip(e,s){this.hideReadingTooltip();let t=document.createElement("div");t.className="block-properties-tooltip block-properties-reading-tooltip";let i=document.createElement("div");i.className="block-properties-tooltip-header",i.textContent=`^${s.blockId}`,t.appendChild(i);let o=document.createElement("div");o.className="block-properties-tooltip-list";for(let a of s.properties){let c=document.createElement("div");c.className="block-properties-tooltip-item";let p=document.createElement("span");p.className="block-properties-tooltip-key",p.textContent=a.key;let r=document.createElement("span");r.className="block-properties-tooltip-value",r.textContent=a.value,c.appendChild(p),c.appendChild(r),o.appendChild(c)}t.appendChild(o);let l=e.getBoundingClientRect();t.style.position="fixed",t.style.left=`${l.left}px`,t.style.top=`${l.top-8}px`,t.style.transform="translateY(-100%)",t.style.zIndex="1000",document.body.appendChild(t),this.readingTooltip=t}hideReadingTooltip(){this.readingTooltip&&(this.readingTooltip.remove(),this.readingTooltip=null)}onunload(){var e;this.styleEl&&this.styleEl.remove(),(e=this.backlinkIndex)==null||e.unregisterFileEvents()}getBacklinkIndex(){return this.backlinkIndex}async loadSettings(){this.settings=Object.assign({},ae,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}updateStyles(){this.styleEl||(this.styleEl=document.createElement("style"),this.styleEl.id="block-properties-styles",document.head.appendChild(this.styleEl)),this.styleEl.textContent=`
			.block-property {
				color: ${this.settings.propertyColor};
				opacity: ${this.settings.opacity};
				font-size: 0.9em;
			}
		`,document.body.classList.toggle("bp-use-presets",this.settings.enableConditionalStyling&&this.settings.usePresetStyles)}refreshEditorExtension(){let e=Y(this.settings.displayMode,this.settings,this.settings.enableLinkedProperties?this.app:void 0);this.editorExtension.length=0,this.editorExtension.push(...e),this.app.workspace.updateOptions()}getSuggest(){return this.suggest}generateBlockId(){let e="abcdefghijklmnopqrstuvwxyz0123456789",s="";for(let t=0;t<6;t++)s+=e.charAt(Math.floor(Math.random()*e.length));return s}};
